\n==================================================\nFILE: client\src\App.css\n==================================================\n\n#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
\n\n\n==================================================\nFILE: client\src\App.jsx\n==================================================\n\nimport { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext';
import { ToastContainer } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';

import Navbar from './components/Navbar';
import Login from './pages/Login';
import Register from './pages/Register';
import UserDashboard from './pages/UserDashboard';
import AdminDashboard from './pages/AdminDashboard';

// Protected Route Component (Inline for simplicity)
import { useContext } from 'react';
import AuthContext from './context/AuthContext';

const ProtectedRoute = ({ children, role }) => {
  const { user } = useContext(AuthContext);

  if (!user) {
    return <Navigate to="/login" />;
  }

  if (role && user.role !== role) {
    return <Navigate to="/" />;
  }

  return children;
};

function App() {
  return (
    <Router>
      <AuthProvider>
        <Navbar />
        <Routes>
          <Route path="/" element={
            <div className="container" style={{ textAlign: 'center', marginTop: '4rem' }}>
              <h1>Welcome to Cargo Management System</h1>
              <p style={{ fontSize: '1.2rem', color: 'var(--text-muted)' }}>
                Efficient route planning and cargo logistics.
              </p>
            </div>
          } />
          <Route path="/login" element={<Login />} />
          <Route path="/register" element={<Register />} />

          <Route path="/dashboard" element={
            <ProtectedRoute>
              <UserDashboard />
            </ProtectedRoute>
          } />

          <Route path="/admin" element={
            <ProtectedRoute role="admin">
              <AdminDashboard />
            </ProtectedRoute>
          } />
        </Routes>
        <ToastContainer position="bottom-right" theme="dark" />
      </AuthProvider>
    </Router>
  );
}

export default App;
\n\n\n==================================================\nFILE: client\src\components\Map.jsx\n==================================================\n\nimport { MapContainer, TileLayer, Marker, Popup, Polyline, useMapEvents } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import icon from 'leaflet/dist/images/marker-icon.png';
import iconShadow from 'leaflet/dist/images/marker-shadow.png';

// Fix Leaflet Default Icon Issue
let DefaultIcon = L.icon({
    iconUrl: icon,
    shadowUrl: iconShadow,
    iconSize: [25, 41],
    iconAnchor: [12, 41]
});

L.Marker.prototype.options.icon = DefaultIcon;

// Helper component to handle map clicks
const LocationPicker = ({ onMapClick }) => {
    useMapEvents({
        click(e) {
            onMapClick(e.latlng);
        },
    });
    return null;
};

const MapComponent = ({ stations, routes, selectedRoute, onMapClick }) => {
    const center = [40.8533, 29.8815]; // Kocaeli Center Coordinates

    // Generate random colors for different routes
    const colors = ['blue', 'red', 'green', 'purple', 'orange', 'black'];

    return (
        <MapContainer center={center} zoom={10} scrollWheelZoom={true} style={{ height: "100%", width: "100%", borderRadius: "1rem", minHeight: "500px" }}>
            <TileLayer
                attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
            />
            {stations.map(station => (
                <Marker key={station.id} position={[station.latitude, station.longitude]}>
                    <Popup>
                        <b>{station.name}</b> <br />
                        {station.is_center ? '(Distribution Center)' : 'Station'}
                    </Popup>
                </Marker>
            ))}

            {routes && routes.map((route, index) => (
                <Polyline
                    key={index}
                    positions={route.path.map(p => [p.latitude, p.longitude])}
                    color={colors[index % colors.length]}
                    weight={5}
                >
                    <Popup>
                        Vehicle: {route.vehicleId} <br />
                        Total Weight: {route.totalWeight} kg <br />
                        Cost: {route.cost}
                    </Popup>
                </Polyline>
            ))}

            {/* Active Vehicle Route (Full Path - Orange) */}
            {selectedRoute && selectedRoute.type === 'vehicle' && (
                <Polyline
                    positions={selectedRoute.path.map(p => [p.latitude, p.longitude])}
                    color="orange"
                    weight={5}
                >
                    <Popup>{selectedRoute.description}</Popup>
                </Polyline>
            )}

            {/* Highlighted Segment (Specific Leg - Red) */}
            {selectedRoute && selectedRoute.highlightedSegment && (
                <Polyline
                    positions={selectedRoute.highlightedSegment.map(p => [p.latitude, p.longitude])}
                    color="red"
                    weight={7}
                >
                    <Popup>Segment: {selectedRoute.segmentDescription}</Popup>
                </Polyline>
            )}

            {/* Legacy/Standard Selected Route (for single cargo view) */}
            {selectedRoute && selectedRoute.type !== 'vehicle' && !selectedRoute.highlightedSegment && (
                <Polyline
                    positions={selectedRoute.path.map(p => [p.latitude, p.longitude])}
                    color={selectedRoute.color || 'orange'}
                    weight={selectedRoute.weight || 6}
                    dashArray={selectedRoute.dashed ? "10, 10" : null}
                >
                    <Popup>
                        {selectedRoute.description}
                    </Popup>
                </Polyline>
            )}

            {/* Click Handler */}
            {onMapClick && <LocationPicker onMapClick={onMapClick} />}
        </MapContainer>
    );
};

export default MapComponent;
\n\n\n==================================================\nFILE: client\src\components\Navbar.jsx\n==================================================\n\nimport { Link, useNavigate } from 'react-router-dom';
import { useContext } from 'react';
import AuthContext from '../context/AuthContext';
import logoutIcon from '../assets/logout-removebg-preview.png';

import bgImage from '../assets/pngtree-black-yellow-line-geometric-display-board-background-image_345516.jpg';

const Navbar = () => {
    const { user, logout } = useContext(AuthContext);
    const navigate = useNavigate();

    const handleLogout = () => {
        logout();
        navigate('/login');
    };

    return (
        <nav className="navbar glass" style={{
            backgroundImage: `url(${bgImage})`,
            backgroundSize: '100% 100%', // Stretch as requested
            backgroundPosition: 'center',
            backgroundRepeat: 'no-repeat'
        }}>
            <div className="container flex justify-between items-center" style={{ maxWidth: '100%', padding: '0 2rem' }}>
                <Link to="/" style={{ textDecoration: 'none' }}>
                    <h1 style={{ fontSize: '1.8rem', color: 'var(--primary)', background: 'none', WebkitTextFillColor: 'initial' }}>Cargo Management</h1>
                </Link>
                <div className="flex items-center" style={{ gap: '1.5rem' }}>
                    {user ? (
                        <>
                            <span style={{ color: 'var(--text)', fontSize: '1.2rem', fontWeight: 'bold' }}>Hello, {user.username}</span>
                            {user.role === 'admin' ? (
                                <Link to="/admin" className="btn" style={{ background: 'var(--surface)', fontSize: '1.1rem', padding: '0.6rem 1.2rem' }}>Admin Panel</Link>
                            ) : (
                                <Link to="/dashboard" className="btn" style={{ background: 'var(--surface)', fontSize: '1.1rem', padding: '0.6rem 1.2rem' }}>Dashboard</Link>
                            )}
                            <button
                                onClick={handleLogout}
                                style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '0',
                                    display: 'flex',
                                    alignItems: 'center'
                                }}
                                title="Logout"
                            >
                                <img src={logoutIcon} alt="Logout" style={{ width: '40px', height: '40px', objectFit: 'contain' }} />
                            </button>
                        </>
                    ) : (
                        <>
                            <Link to="/login" className="btn-primary" style={{ borderRadius: '5px', padding: '0.7rem 2rem', fontSize: '1.1rem' }}>Login</Link>
                            <Link to="/register" className="btn-primary" style={{ borderRadius: '5px', padding: '0.7rem 2rem', fontSize: '1.1rem' }}>Register</Link>
                        </>
                    )}
                </div>
            </div>
        </nav>
    );
};

export default Navbar;
\n\n\n==================================================\nFILE: client\src\constants\scenarios.js\n==================================================\n\nexport const SCENARIOS = {
    1: {
        name: "Senaryo 1",
        data: [
            { name: "Başiskele", count: 10, weight: 120 },
            { name: "Çayırova", count: 8, weight: 80 },
            { name: "Darıca", count: 15, weight: 200 },
            { name: "Derince", count: 10, weight: 150 },
            { name: "Dilovası", count: 12, weight: 180 },
            { name: "Gebze", count: 5, weight: 70 },
            { name: "Gölcük", count: 7, weight: 90 },
            { name: "Kandıra", count: 6, weight: 60 },
            { name: "Karamürsel", count: 9, weight: 110 },
            { name: "Kartepe", count: 11, weight: 130 },
            { name: "Körfez", count: 6, weight: 75 },
            { name: "İzmit", count: 14, weight: 160 }
        ]
    },
    2: {
        name: "Senaryo 2",
        data: [
            { name: "Başiskele", count: 40, weight: 200 },
            { name: "Çayırova", count: 35, weight: 175 },
            { name: "Darıca", count: 10, weight: 150 },
            { name: "Derince", count: 5, weight: 100 },
            // Dilovası: 0
            { name: "Gebze", count: 8, weight: 120 },
            // Gölcük: 0, Kandıra: 0, Karamürsel: 0, Kartepe: 0, Körfez: 0
            { name: "İzmit", count: 20, weight: 160 }
        ]
    },
    3: {
        name: "Senaryo 3",
        data: [
            // Başiskele: 0
            { name: "Çayırova", count: 3, weight: 700 },
            // Darıca: 0, Derince: 0
            { name: "Dilovası", count: 4, weight: 800 },
            { name: "Gebze", count: 5, weight: 900 },
            // Gölcük..Körfez: 0
            { name: "İzmit", count: 5, weight: 300 }
        ]
    },
    4: {
        name: "Senaryo 4",
        data: [
            { name: "Başiskele", count: 30, weight: 300 },
            // Çayırova..Derince..Dilovası..Gebze: 0
            { name: "Gölcük", count: 15, weight: 220 },
            { name: "Kandıra", count: 5, weight: 250 },
            { name: "Karamürsel", count: 20, weight: 180 },
            { name: "Kartepe", count: 10, weight: 200 },
            { name: "Körfez", count: 8, weight: 400 },
            // İzmit: 0
        ]
    }
};
\n\n\n==================================================\nFILE: client\src\context\AuthContext.jsx\n==================================================\n\nimport { createContext, useState, useEffect } from 'react';
import authService from '../services/authService';

const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const storedUser = authService.getCurrentUser();
        if (storedUser) {
            setUser(storedUser);
        }
        setLoading(false);
    }, []);

    const login = async (username, password) => {
        const data = await authService.login(username, password);
        setUser(data.user);
        return data;
    };

    const register = async (username, password, role) => {
        return await authService.register(username, password, role);
    };

    const logout = () => {
        authService.logout();
        setUser(null);
    };

    return (
        <AuthContext.Provider value={{ user, login, register, logout, loading }}>
            {!loading && children}
        </AuthContext.Provider>
    );
};

export default AuthContext;
\n\n\n==================================================\nFILE: client\src\index.css\n==================================================\n\n:root {
  --primary: #fcd34d;
  /* Warm Yellow for "Sari" */
  --primary-hover: #fbbf24;
  --secondary: #94a3b8;
  /* Light Grey */
  --background: #1e1e1e;
  /* Dark Smoked Grey (Füme) */
  --surface: #2d2d2d;
  /* Slightly lighter Smoked Grey */
  --text: #e2e8f0;
  /* White-ish Grey */
  --text-muted: #94a3b8;
  --border: #404040;
  --glass: rgba(45, 45, 45, 0.85);
}

body {
  margin: 0;
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background-color: var(--background);
  color: var(--text);
  line-height: 1.6;
  overflow-x: hidden;
}

#root {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Glassmorphism */
.glass {
  background: var(--glass);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Typography */
h1,
h2,
h3,
h4,
h5,
h6 {
  font-weight: 700;
  margin-bottom: 1rem;
  line-height: 1.2;
  background: linear-gradient(to right, var(--primary), #fbbf24);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

a {
  color: var(--primary);
  text-decoration: none;
  transition: all 0.2s;
}

a:hover {
  color: var(--secondary);
}

/* Buttons */
button,
.btn {
  padding: 0.75rem 1.5rem;
  border-radius: 0.75rem;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1rem;
  display: inline-block;
  text-align: center;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), #eab308);
  /* Rich Yellow Gradient */
  color: #1e1e1e;
  /* Dark text for contrast on yellow */
  box-shadow: 0 4px 15px rgba(252, 211, 77, 0.4);
  border: 1px solid #000000;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
  filter: brightness(1.1);
}

/* Forms */
input,
select,
textarea {
  width: 100%;
  padding: 0.75rem;
  border-radius: 0.75rem;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 1rem;
  transition: all 0.2s;
  box-sizing: border-box;
  margin-bottom: 1rem;
}

input:focus,
select:focus,
textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

/* Layout Utilities */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.flex {
  display: flex;
}

.flex-col {
  flex-direction: column;
}

.justify-between {
  justify-content: space-between;
}

.items-center {
  align-items: center;
}

.justify-center {
  justify-content: center;
}

.gap-4 {
  gap: 1rem;
}

.h-screen {
  min-height: 80vh;
}

/* Card */
.card {
  background: var(--surface);
  border-radius: 1rem;
  padding: 2rem;
  border: 1px solid var(--border);
}

/* Navbar */
.navbar {
  padding: 0.5rem 0;
  /* Reduced height */
  position: relative;
  /* Embedded in page flow, not sticky/fixed */
  z-index: 100;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* Table Hover */
tr.hover-row:hover {
  background-color: rgba(255, 255, 255, 0.1);
  transition: background-color 0.2s;
}\n\n\n==================================================\nFILE: client\src\main.jsx\n==================================================\n\nimport { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
\n\n\n==================================================\nFILE: client\src\pages\AdminDashboard.jsx\n==================================================\n\nimport { useState, useEffect } from 'react';
import MapComponent from '../components/Map';
import stationService from '../services/stationService';
import cargoService from '../services/cargoService';
import vehicleService from '../services/vehicleService';
import optimizationService from '../services/optimizationService';
import routingService from '../services/routingService';
import { SCENARIOS } from '../constants/scenarios';
import { toast } from 'react-toastify';

const AdminDashboard = () => {
    const [stations, setStations] = useState([]);
    const [cargos, setCargos] = useState([]);
    const [vehicles, setVehicles] = useState([]);

    const handleToggleMaintenance = async (vehicle) => {
        try {
            const newStatus = vehicle.status === 'active' ? 'maintenance' : 'active';
            await vehicleService.updateVehicleStatus(vehicle.id, newStatus);
            toast.success(`Vehicle ${vehicle.plate_number} set to ${newStatus}`);
            fetchVehicles(); // Refresh list
        } catch (error) {
            toast.error('Failed to update vehicle status');
        }
    };

    const [activeRoutes, setActiveRoutes] = useState([]); // Vehicles with routes
    const [routes, setRoutes] = useState([]);
    const [selectedRoute, setSelectedRoute] = useState(null);
    const [loading, setLoading] = useState(false);
    const [newVehicle, setNewVehicle] = useState({ plate_number: '', capacity_kg: 500, base_cost: 0, fuel_cost_per_km: 1 });
    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]); // Default today
    const [newStation, setNewStation] = useState({ name: '', latitude: '', longitude: '' });
    const [isPickingLocation, setIsPickingLocation] = useState(false);
    const [expandedStepId, setExpandedStepId] = useState(null); // Track expanded route stop for details
    const [showAnalysisModal, setShowAnalysisModal] = useState(false);
    const [optimizationMode, setOptimizationMode] = useState('unlimited'); // 'unlimited', 'fixed_count', 'fixed_weight'
    const [scenarioComparison, setScenarioComparison] = useState(null);

    useEffect(() => {
        if (showAnalysisModal) {
            optimizationService.analyzeAllScenarios(selectedDate).then(data => setScenarioComparison(data));
        }
    }, [showAnalysisModal, selectedDate]);

    useEffect(() => {
        fetchStations();
        fetchCargos();
        fetchVehicles();
        fetchActiveRoutes();
    }, [selectedDate]); // Re-fetch when date changes

    const fetchActiveRoutes = async () => {
        try {
            const data = await vehicleService.getVehicleRoutes(selectedDate);
            setActiveRoutes(data);
        } catch (error) {
            console.error(error);
            // toast.error('Failed to load active routes');
        }
    };

    // ... Existing fetchFunctions ...

    const fetchStations = async () => {
        try {
            const data = await stationService.getStations();
            setStations(data);
        } catch (error) {
            toast.error('Failed to load stations');
        }
    };

    const fetchCargos = async () => {
        try {
            const data = await cargoService.getAllCargos(selectedDate);
            setCargos(data);
        } catch (error) {
            toast.error('Failed to load cargos');
        }
    };

    const handleAddStation = async (e) => {
        e.preventDefault();
        try {
            await stationService.addStation(newStation);
            toast.success('Station added successfully');
            fetchStations();
            setNewStation({ name: '', latitude: '', longitude: '' });
            setIsPickingLocation(false);
        } catch (error) {
            toast.error('Failed to add station');
        }
    };

    const handleMapClick = (latlng) => {
        if (isPickingLocation) {
            setNewStation({ ...newStation, latitude: latlng.lat, longitude: latlng.lng });
            // setIsPickingLocation(false); // Optional: Keep picking enabled until save or manual toggle
            toast.info(`Location picked: ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`);
        }
    };

    const fetchVehicles = async () => {
        try {
            const data = await vehicleService.getVehicles();
            setVehicles(data);
        } catch (error) {
            // endpoint might not exist yet, suppress error for now or log
            console.error('Failed to load vehicles');
        }
    };

    const handleAddVehicle = async (e) => {
        e.preventDefault();
        try {
            await vehicleService.addVehicle(newVehicle);
            toast.success('Vehicle added successfully');
            fetchVehicles();
            setNewVehicle({ plate_number: '', capacity_kg: 500, base_cost: 0, fuel_cost_per_km: 1 });
        } catch (error) {
            toast.error('Failed to add vehicle');
        }
    };

    const handleOptimize = async () => {
        const pendingCargos = cargos.filter(c => c.status === 'pending');
        const pendingIds = pendingCargos.map(c => c.id);

        if (pendingIds.length === 0) {
            toast.warn('No pending cargos to optimize.');
            return;
        }

        if (!window.confirm(`Optimize routes for all ${pendingIds.length} pending cargos?`)) return;

        setLoading(true);
        try {
            const result = await optimizationService.optimizeRoutes(pendingIds, optimizationMode, selectedDate);
            if (result.success && result.data && result.data.routes) {
                setRoutes(result.data.routes);
                const msg = `Optimization completed! ${result.data.routes.length} routes.`;
                const dropped = result.data.droppedStations;
                if (dropped && dropped > 0) {
                    toast.warning(`${msg} (${dropped} locations could not be served in Fixed Mode)`);
                } else {
                    toast.success(msg);
                }

                fetchCargos(); // Refresh status
            } else {
                toast.success('Optimization completed (No routes generated or empty)');
            }
        } catch (error) {
            toast.error('Optimization failed');
        } finally {
            setLoading(false);
        }
    };

    const handleCargoClick = async (cargo) => {
        // Find Center Station (KOÜ)
        const centerStation = stations.find(s => s.is_center);
        // Find Target Station from the full list to ensure we have coordinates
        const targetStation = stations.find(s => s.id === cargo.station_id);

        if (centerStation && targetStation) {
            // Show toast first
            toast.info(`Calculating route for Cargo #${cargo.id}...`);

            // Fetch real road path
            const realPath = await routingService.getRoute(
                centerStation.latitude,
                centerStation.longitude,
                targetStation.latitude,
                targetStation.longitude
            );

            // Fallback to straight line if API fails
            const finalPath = realPath || [
                { latitude: centerStation.latitude, longitude: centerStation.longitude },
                { latitude: targetStation.latitude, longitude: targetStation.longitude }
            ];

            setSelectedRoute({
                path: finalPath,
                color: cargo.status === 'planned' ? 'red' : 'orange', // Planned = Red, Pending = Orange
                description: `Cargo #${cargo.id} -> ${targetStation.name} (${cargo.status})`
            });

            if (realPath) {
                toast.success(`Shown road route to ${targetStation.name}`);
            } else {
                toast.warning(`Road route unavailable, showing straight line to ${targetStation.name}`);
            }

        } else {
            console.warn('Coordinates missing:', { centerStation, targetStation, cargoStationId: cargo.station_id });
            toast.warning('Station coordinates not found. Please refresh data.');
        }
    };

    const handleVehicleRouteClick = async (vehicleRoute) => {
        console.log("Clicked Vehicle Route:", vehicleRoute);
        const stops = vehicleRoute.Routes[0].RouteStops;
        console.log("Stops:", stops);

        if (!stops || stops.length === 0) {
            console.warn("No stops found for this route.");
            return;
        }

        toast.info(`Calculating full road route for ${vehicleRoute.plate_number}...`);

        let fullPath = [];

        // Collect all waypoints
        const waypoints = [];

        // Add Start Point (Previous of First Stop)
        if (stops[0].PreviousStation) {
            waypoints.push(stops[0].PreviousStation);
        } else {
            console.warn("First stop missing PreviousStation (Start Point)");
        }

        // Add All Stops
        stops.forEach(s => {
            if (s.Station) waypoints.push(s.Station);
        });

        // Add End Point (Next of Last Stop - Return to Center)
        if (stops[stops.length - 1].NextStation) {
            waypoints.push(stops[stops.length - 1].NextStation);
        } else {
            console.warn("Last stop missing NextStation (End Point)");
        }

        console.log("Waypoints to route:", waypoints);

        if (waypoints.length < 2) {
            toast.error("Not enough waypoints to calculate route.");
            return;
        }

        // Now fetch routes between consecutive waypoints
        for (let i = 0; i < waypoints.length - 1; i++) {
            const start = waypoints[i];
            const end = waypoints[i + 1];
            try {
                const legPath = await routingService.getRoute(start.latitude, start.longitude, end.latitude, end.longitude);
                if (legPath) {
                    fullPath = fullPath.concat(legPath);
                } else {
                    // Fallback straight line
                    fullPath.push({ latitude: start.latitude, longitude: start.longitude });
                    fullPath.push({ latitude: end.latitude, longitude: end.longitude });
                }
            } catch (error) {
                console.error("Routing error for leg", i, error);
                fullPath.push({ latitude: start.latitude, longitude: start.longitude });
                fullPath.push({ latitude: end.latitude, longitude: end.longitude });
            }
        }

        console.log("Full Path Points:", fullPath.length);

        setSelectedRoute({
            type: 'vehicle',
            path: fullPath,
            description: `Vehicle ${vehicleRoute.plate_number} Full Road Route`,
            vehicleRoute: vehicleRoute
        });
        toast.success(`Shown full road route for ${vehicleRoute.plate_number}`);
    };

    const handleStopSegmentClick = async (stop) => {
        if (!selectedRoute || selectedRoute.type !== 'vehicle') return;

        let segmentPath = [];
        if (stop.PreviousStation && stop.Station) {
            try {
                const realPath = await routingService.getRoute(
                    stop.PreviousStation.latitude,
                    stop.PreviousStation.longitude,
                    stop.Station.latitude,
                    stop.Station.longitude
                );
                segmentPath = realPath || [
                    { latitude: stop.PreviousStation.latitude, longitude: stop.PreviousStation.longitude },
                    { latitude: stop.Station.latitude, longitude: stop.Station.longitude }
                ];
            } catch (e) {
                segmentPath = [
                    { latitude: stop.PreviousStation.latitude, longitude: stop.PreviousStation.longitude },
                    { latitude: stop.Station.latitude, longitude: stop.Station.longitude }
                ];
            }
        }

        setSelectedRoute(prev => ({
            ...prev,
            highlightedSegment: segmentPath,
            segmentDescription: `Segment to ${stop.Station.name}`
        }));
    };



    return (
        <div style={{ height: 'calc(100vh - 80px)', overflow: 'hidden', padding: '1rem' }}>
            <div className="flex gap-4" style={{ height: '100%' }}>

                {/* LEFT SIDE: Controls & Lists (Scrollable) */}
                <div className="flex flex-col gap-4" style={{ flex: 1, overflowY: 'auto', paddingRight: '0.5rem' }}>

                    {/* Station Management (Updated) */}
                    <div className="card glass">
                        <h3>Station Management</h3>
                        <form onSubmit={handleAddStation} className="flex flex-col gap-2">
                            <label>Station Name</label>
                            <input
                                type="text"
                                placeholder="Station Name"
                                value={newStation.name}
                                onChange={(e) => setNewStation({ ...newStation, name: e.target.value })}
                                required
                            />

                            <div className="flex gap-2">
                                <div style={{ flex: 1 }}>
                                    <label>Latitude</label>
                                    <input
                                        type="number"
                                        placeholder="Lat"
                                        value={newStation.latitude}
                                        onChange={(e) => setNewStation({ ...newStation, latitude: e.target.value })}
                                        required
                                        step="any"
                                    />
                                </div>
                                <div style={{ flex: 1 }}>
                                    <label>Longitude</label>
                                    <input
                                        type="number"
                                        placeholder="Lng"
                                        value={newStation.longitude}
                                        onChange={(e) => setNewStation({ ...newStation, longitude: e.target.value })}
                                        required
                                        step="any"
                                    />
                                </div>
                            </div>

                            <button
                                type="button"
                                className="btn"
                                onClick={() => setIsPickingLocation(!isPickingLocation)}
                                style={{
                                    background: isPickingLocation ? 'var(--primary)' : 'rgba(255,255,255,0.3)',
                                    border: '1px solid #000000',
                                    marginBottom: '0.5rem',
                                    color: isPickingLocation ? '#1e1e1e' : 'var(--text)'
                                }}
                            >
                                {isPickingLocation ? 'Tap on Map to Pick' : 'Pick from Map'}
                            </button>

                            <button type="submit" className="btn-primary">Add Station</button>
                        </form>
                    </div>

                    {/* Date Picker (NEW) */}
                    <div className="card glass">
                        <h3>Date Selection</h3>
                        <input
                            type="date"
                            value={selectedDate}
                            onChange={(e) => setSelectedDate(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '0.5rem',
                                marginTop: '0.5rem',
                                background: 'rgba(255,255,255,0.05)',
                                border: '1px solid var(--border)',
                                color: 'var(--text)',
                                borderRadius: '0.25rem'
                            }}
                        />
                    </div>

                    {/* Cargo Request & Actions (Merged) */}
                    <div className="card glass">
                        <div className="flex flex-col gap-2 mb-4">
                            <div className="flex justify-between items-center">
                                <h3>Cargo Request</h3>
                                <div className="flex gap-4">
                                    <button
                                        className="btn-primary"
                                        onClick={() => setShowAnalysisModal(true)}
                                    >
                                        Analyze Scenarios
                                    </button>
                                    <button
                                        className="btn-primary"
                                        onClick={handleOptimize}
                                        disabled={loading}
                                    >
                                        {loading ? 'Optimizing...' : 'Optimize Routes'}
                                    </button>
                                </div>
                            </div>

                            {/* Mode Selection */}
                            <div className="flex gap-2 items-center" style={{ background: 'rgba(255,255,255,0.05)', padding: '0 1rem', borderRadius: '0.5rem', height: '50px' }}>
                                <label style={{ fontSize: '1rem', color: 'var(--text-muted)', whiteSpace: 'nowrap' }}>Mod:</label>
                                <select
                                    value={optimizationMode}
                                    onChange={(e) => setOptimizationMode(e.target.value)}
                                    style={{ background: 'transparent', padding: '0 1rem', color: 'var(--text)', border: 'none', outline: 'none', flex: 1, height: '80%', cursor: 'pointer', fontSize: '0.95rem' }}
                                >
                                    <option value="unlimited" style={{ color: 'black' }}>Fixed - Rental Vehicle</option>
                                    <option value="fixed_count" style={{ color: 'black' }}>Fixed - Max Count </option>
                                    <option value="fixed_weight" style={{ color: 'black' }}>Fixed - Max Weight </option>
                                </select>
                            </div>
                        </div>

                        {/* Cargo List Table */}
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '1rem' }}>
                                <thead>
                                    <tr style={{ borderBottom: '1px solid var(--border)', textAlign: 'left' }}>

                                        <th style={{ padding: '0.5rem' }}>ID</th>
                                        <th style={{ padding: '0.5rem' }}>User</th>
                                        <th style={{ padding: '0.5rem' }}>Station</th>
                                        <th style={{ padding: '0.5rem' }}>Weight</th>
                                        <th style={{ padding: '0.5rem' }}>Status</th>
                                        <th style={{ padding: '0.5rem' }}>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {cargos.filter(c => c.status === 'pending').length === 0 ? (
                                        <tr>
                                            <td colSpan="7" style={{ padding: '1rem', textAlign: 'center', color: 'var(--text-muted)' }}>
                                                No pending cargo requests.
                                            </td>
                                        </tr>
                                    ) : (
                                        cargos
                                            .filter(c => c.status === 'pending')
                                            .map(cargo => (
                                                <tr
                                                    key={cargo.id}
                                                    style={{ borderBottom: '1px solid rgba(255,255,255,0.05)', cursor: 'pointer' }}
                                                    onClick={() => handleCargoClick(cargo)}
                                                    className="hover-row"
                                                >
                                                    <td style={{ padding: '0.5rem' }}>#{cargo.id}</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.User ? cargo.User.username : 'Unknown'}</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.Station ? cargo.Station.name : '-'}</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.weight_kg} kg</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.status}</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.request_date}</td>
                                                </tr>
                                            ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Vehicle Management */}
                    <div className="card glass">
                        <h3>Vehicle Management</h3>
                        <div className="flex flex-col gap-4">
                            {/* Add Vehicle Form */}
                            <div>
                                <h4>Add New Vehicle</h4>
                                <form onSubmit={handleAddVehicle} className="flex flex-col">
                                    <label>Plate Number</label>
                                    <input type="text" placeholder="34 ABC 123" value={newVehicle.plate_number} onChange={e => setNewVehicle({ ...newVehicle, plate_number: e.target.value })} required />

                                    <label>Capacity (kg)</label>
                                    <input type="number" value={newVehicle.capacity_kg} onChange={e => setNewVehicle({ ...newVehicle, capacity_kg: e.target.value })} required />

                                    <div className="flex gap-4">
                                        <div style={{ flex: 1 }}>
                                            <label>Base Cost</label>
                                            <input type="number" value={newVehicle.base_cost} onChange={e => setNewVehicle({ ...newVehicle, base_cost: e.target.value })} />
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <label>Fuel Cost / km</label>
                                            <input type="number" value={newVehicle.fuel_cost_per_km} step="0.1" onChange={e => setNewVehicle({ ...newVehicle, fuel_cost_per_km: e.target.value })} />
                                        </div>
                                    </div>

                                    <button type="submit" className="btn-primary" style={{ marginTop: '1rem' }}>Add Vehicle</button>
                                </form>
                            </div>

                            {/* Vehicle List */}
                            <div>
                                <h4>Existing Vehicles</h4>
                                <ul style={{ listStyle: 'none', padding: 0 }}>
                                    {vehicles.filter(v => !v.is_rental).map(v => (
                                        <li key={v.id} style={{ padding: '0.5rem', background: 'rgba(255,255,255,0.05)', marginBottom: '0.5rem', borderRadius: '0.5rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <span><b>{v.plate_number}</b> ({v.capacity_kg}kg)</span>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <span style={{
                                                    color: v.status === 'active' ? '#4ade80' : '#f87171',
                                                    fontSize: '0.8rem',
                                                    textTransform: 'uppercase'
                                                }}>{v.status}</span>
                                                <button
                                                    onClick={() => handleToggleMaintenance(v)}
                                                    style={{
                                                        padding: '0.2rem 0.5rem',
                                                        fontSize: '0.7rem',
                                                        borderRadius: '0.25rem',
                                                        border: '1px solid var(--border)',
                                                        background: 'rgba(255,255,255,0.1)',
                                                        color: 'var(--text)',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    {v.status === 'active' ? 'Set Maint.' : 'Set Active'}
                                                </button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </div>

                    {/* Active Vehicle Routes Pane (NEW) */}
                    <div className="card glass">
                        <div className="flex flex-col gap-1 mb-2">
                            <h3>Active Vehicle Routes</h3>
                            {activeRoutes.length > 0 && (
                                <div style={{ fontSize: '0.85rem', color: 'var(--text-muted)', display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                    <span>
                                        Total Cost: <b style={{ color: 'var(--text)' }}>
                                            {activeRoutes.reduce((sum, v) => sum + Number(v.Routes[0].total_cost || 0), 0).toFixed(2)} TL
                                        </b>
                                    </span>
                                    <span>
                                        Total Dist: <b style={{ color: 'var(--text)' }}>
                                            {activeRoutes.reduce((sum, v) => sum + Number(v.Routes[0].total_distance_km || 0), 0).toFixed(1)} km
                                        </b>
                                    </span>
                                    <span>
                                        Total Weight: <b style={{ color: 'var(--text)' }}>
                                            {activeRoutes.reduce((sum, v) => sum + (v.Cargos ? v.Cargos.reduce((w, c) => w + Number(c.weight_kg), 0) : 0), 0)} kg
                                        </b>
                                    </span>
                                </div>
                            )}
                        </div>
                        <div className="flex flex-col gap-2">
                            {activeRoutes.length === 0 ? (
                                <p style={{ color: 'var(--text-muted)' }}>No routes for selected date.</p>
                            ) : (
                                activeRoutes.map(v => (
                                    <div key={v.id} style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '0.5rem', overflow: 'hidden' }}>
                                        {/* Vehicle Header */}
                                        <div
                                            style={{ padding: '0.5rem', cursor: 'pointer', background: 'rgba(255,255,255,0.1)', fontWeight: 'bold' }}
                                            onClick={() => handleVehicleRouteClick(v)}
                                        >
                                            {v.plate_number} <span style={{ fontSize: '0.8rem', fontWeight: 'normal' }}>({v.Routes[0].total_distance_km} km)</span>
                                        </div>

                                        <div style={{ padding: '0.5rem' }}>
                                            {v.Routes[0].RouteStops.map((stop, idx) => {
                                                const stopCargos = v.Cargos ? v.Cargos.filter(c => c.station_id === stop.station_id) : [];
                                                const isExpanded = expandedStepId === stop.id;

                                                return (
                                                    <div key={stop.id} style={{ marginBottom: '0.25rem' }}>
                                                        <div
                                                            style={{
                                                                fontSize: '0.9rem',
                                                                padding: '0.25rem 0.5rem',
                                                                cursor: 'pointer',
                                                                borderLeft: '2px solid var(--primary)',
                                                                marginLeft: '0.5rem',
                                                                display: 'flex',
                                                                justifyContent: 'space-between',
                                                                alignItems: 'center',
                                                                background: isExpanded ? 'rgba(255,255,255,0.05)' : 'transparent'
                                                            }}
                                                            className="hover-row"
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                handleStopSegmentClick(stop);
                                                            }}
                                                        >
                                                            <span>Step {idx + 1}: {stop.Station ? stop.Station.name : 'Unknown'}</span>

                                                            {stopCargos.length > 0 && (
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setExpandedStepId(isExpanded ? null : stop.id);
                                                                    }}
                                                                    style={{
                                                                        fontSize: '0.7rem',
                                                                        padding: '0.1rem 0.4rem',
                                                                        borderRadius: '4px',
                                                                        border: '1px solid var(--border)',
                                                                        background: 'rgba(255,255,255,0.1)',
                                                                        color: 'var(--text-muted)',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                >
                                                                    {isExpanded ? 'Hide' : `Cargos (${stopCargos.length})`}
                                                                </button>
                                                            )}
                                                        </div>

                                                        {isExpanded && stopCargos.length > 0 && (
                                                            <div style={{ marginLeft: '1rem', padding: '0.5rem', background: 'rgba(0,0,0,0.2)', fontSize: '0.8rem' }}>
                                                                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                                                                    {stopCargos.map(c => (
                                                                        <li key={c.id} style={{ display: 'flex', justifyContent: 'space-between', borderBottom: '1px solid rgba(255,255,255,0.05)', padding: '2px 0' }}>
                                                                            <span>Cargo #{c.id}</span>
                                                                            <span>{c.weight_kg} kg</span>
                                                                        </li>
                                                                    ))}
                                                                </ul>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* Planned Cargos Pane (NEW) */}
                    <div className="card glass">
                        <h3>Planned Cargos</h3>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '1rem' }}>
                                <thead>
                                    <tr style={{ borderBottom: '1px solid var(--border)', textAlign: 'left' }}>
                                        <th style={{ padding: '0.5rem' }}>ID</th>
                                        <th style={{ padding: '0.5rem' }}>User</th>
                                        <th style={{ padding: '0.5rem' }}>Station</th>
                                        <th style={{ padding: '0.5rem' }}>Weight</th>
                                        <th style={{ padding: '0.5rem' }}>Status</th>
                                        <th style={{ padding: '0.5rem' }}>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {cargos.filter(c => c.status === 'planned').length === 0 ? (
                                        <tr>
                                            <td colSpan="6" style={{ padding: '1rem', textAlign: 'center', color: 'var(--text-muted)' }}>
                                                No planned cargos yet.
                                            </td>
                                        </tr>
                                    ) : (
                                        cargos
                                            .filter(c => c.status === 'planned')
                                            .map(cargo => (
                                                <tr
                                                    key={cargo.id}
                                                    style={{ borderBottom: '1px solid rgba(255,255,255,0.05)', cursor: 'pointer' }}
                                                    onClick={() => handleCargoClick(cargo)}
                                                    className="hover-row"
                                                >
                                                    <td style={{ padding: '0.5rem' }}>#{cargo.id}</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.User ? cargo.User.username : 'Unknown'}</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.Station ? cargo.Station.name : '-'}</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.weight_kg} kg</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.status}</td>
                                                    <td style={{ padding: '0.5rem' }}>{cargo.request_date}</td>
                                                </tr>
                                            ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                {/* RIGHT SIDE: Map (Fixed) */}
                <div style={{ flex: 2, height: '100%', position: 'relative' }}>

                    {/* Route Statistics Overlay */}
                    {selectedRoute && selectedRoute.type === 'vehicle' && selectedRoute.vehicleRoute && (
                        <div style={{
                            position: 'absolute',
                            top: '20px',
                            right: '20px',
                            zIndex: 1000,
                            background: 'rgba(30, 41, 59, 0.9)', // fast darker glass
                            backdropFilter: 'blur(10px)',
                            padding: '1rem',
                            borderRadius: '0.75rem',
                            boxShadow: '0 4px 6px rgba(0,0,0,0.3)',
                            border: '1px solid rgba(255,255,255,0.1)',
                            minWidth: '220px',
                            color: 'white'
                        }}>
                            <h4 style={{ margin: '0 0 0.5rem 0', borderBottom: '1px solid rgba(255,255,255,0.2)', paddingBottom: '0.5rem' }}>
                                Route Stats: {selectedRoute.vehicleRoute.plate_number}
                            </h4>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                <div className="flex justify-between">
                                    <span style={{ color: 'var(--text-muted)' }}>Cargos Delivered:</span>
                                    <span style={{ fontWeight: 'bold' }}>{selectedRoute.vehicleRoute.Routes[0].RouteStops.length}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span style={{ color: 'var(--text-muted)' }}>Total Weight:</span>
                                    <span style={{ fontWeight: 'bold' }}>
                                        {selectedRoute.vehicleRoute.Cargos
                                            ? selectedRoute.vehicleRoute.Cargos.reduce((sum, c) => sum + Number(c.weight_kg), 0)
                                            : 0} kg
                                    </span>
                                </div>
                                <div className="flex justify-between">
                                    <span style={{ color: 'var(--text-muted)' }}>Total Distance:</span>
                                    <span style={{ fontWeight: 'bold' }}>{selectedRoute.vehicleRoute.Routes[0].total_distance_km} km</span>
                                </div>
                                <div className="flex justify-between">
                                    <span style={{ color: 'var(--text-muted)' }}>Total Cost:</span>
                                    <span style={{ fontWeight: 'bold' }}>{selectedRoute.vehicleRoute.Routes[0].total_cost} TL</span>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="card glass" style={{ height: '100%', padding: '0.5rem' }}>
                        <MapComponent
                            stations={stations}
                            routes={routes}
                            selectedRoute={selectedRoute}
                            onMapClick={handleMapClick}
                        />
                    </div>
                </div>

            </div>

            {/* ANALYSIS MODAL MOVED TO ROOT */}
            {showAnalysisModal && (
                <div style={{
                    position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh',
                    background: 'rgba(0,0,0,0.8)', zIndex: 999999, display: 'flex', justifyContent: 'center', alignItems: 'center',
                    backdropFilter: 'blur(5px)'
                }}>
                    <div className="card glass" style={{ width: '90%', maxWidth: '900px', maxHeight: '90vh', overflowY: 'auto' }}>

                        {scenarioComparison && (
                            <div style={{ marginBottom: '2rem', padding: '1rem', background: 'rgba(255,255,255,0.05)', borderRadius: '0.5rem' }}>
                                <h3 className="mb-2 text-xl font-bold">Optimization Scenario Comparison</h3>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr style={{ borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                            <th style={{ padding: '0.5rem', textAlign: 'left' }}>Metric</th>
                                            <th style={{ padding: '0.5rem', textAlign: 'left', color: 'cyan' }}>Unlimited (Best Cost)</th>
                                            <th style={{ padding: '0.5rem', textAlign: 'left', color: 'orange' }}>Fixed (Count Mode)</th>
                                            <th style={{ padding: '0.5rem', textAlign: 'left', color: 'lightgreen' }}>Fixed (Weight Mode)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style={{ padding: '0.5rem', color: 'var(--text-muted)' }}>Total Cost</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.unlimited.totalCost.toFixed(2)} TL</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.fixed_count.totalCost.toFixed(2)} TL</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.fixed_weight.totalCost.toFixed(2)} TL</td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '0.5rem', color: 'var(--text-muted)' }}>Total Distance</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.unlimited.totalDistance.toFixed(1)} km</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.fixed_count.totalDistance.toFixed(1)} km</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.fixed_weight.totalDistance.toFixed(1)} km</td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '0.5rem', color: 'var(--text-muted)' }}>Vehicles Used</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.unlimited.vehicleCount}</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.fixed_count.vehicleCount}</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.fixed_weight.vehicleCount}</td>
                                        </tr>
                                        <tr>
                                            <td style={{ padding: '0.5rem', color: 'var(--text-muted)' }}>Total Weight</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.unlimited.totalWeight} kg</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.fixed_count.totalWeight} kg</td>
                                            <td style={{ padding: '0.5rem' }}>{scenarioComparison.fixed_weight.totalWeight} kg</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        )}

                        <div className="flex justify-between items-center mb-4">
                            <h2>Current Active Routes Detail</h2>
                            <button onClick={() => setShowAnalysisModal(false)} className="btn" style={{ background: 'red' }}>Close</button>
                        </div>

                        {activeRoutes.length === 0 ? (
                            <p>No active scenarios/routes found for this date.</p>
                        ) : (
                            <>
                                <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '1rem' }}>
                                    <thead>
                                        <tr style={{ background: 'rgba(255,255,255,0.1)' }}>
                                            <th style={{ padding: '0.5rem', textAlign: 'left' }}>Vehicle</th>
                                            <th style={{ padding: '0.5rem', textAlign: 'left' }}>Total Cost</th>
                                            <th style={{ padding: '0.5rem', textAlign: 'left' }}>Distance</th>
                                            <th style={{ padding: '0.5rem', textAlign: 'left' }}>Weight</th>
                                            <th style={{ padding: '0.5rem', textAlign: 'left' }}>Calculated Users</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {activeRoutes.map(v => {
                                            const route = v.Routes[0];
                                            const totalWeight = v.Cargos ? v.Cargos.reduce((sum, c) => sum + Number(c.weight_kg), 0) : 0;
                                            const users = v.Cargos ? [...new Set(v.Cargos.map(c => c.User ? c.User.username : 'Unknown'))] : [];

                                            return (
                                                <tr key={v.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                                    <td style={{ padding: '0.5rem' }}>{v.plate_number} {v.is_rental && <span style={{ fontSize: '0.8rem', color: 'cyan' }}>(RENTAL)</span>}</td>
                                                    <td style={{ padding: '0.5rem' }}>{route.total_cost} TL</td>
                                                    <td style={{ padding: '0.5rem' }}>{route.total_distance_km} km</td>
                                                    <td style={{ padding: '0.5rem' }}>{totalWeight} kg</td>
                                                    <td style={{ padding: '0.5rem', fontSize: '0.85rem', color: 'var(--text-muted)' }}>
                                                        {users.length > 0 ? users.join(', ') : '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>

                                <div style={{ marginTop: '1rem', padding: '1rem', background: 'rgba(255,255,255,0.05)', borderRadius: '0.5rem' }}>
                                    <h3>Summary Stats</h3>
                                    <div className="flex" style={{ gap: '4rem', justifyContent: 'space-between' }}>
                                        <div style={{ textAlign: 'center' }}>
                                            <span style={{ color: 'var(--text-muted)' }}>Total Cost:</span>
                                            <h2>{activeRoutes.reduce((sum, v) => sum + Number(v.Routes[0].total_cost || 0), 0).toFixed(2)} TL</h2>
                                        </div>
                                        <div style={{ textAlign: 'center' }}>
                                            <span style={{ color: 'var(--text-muted)' }}>Total Fleet Distance:</span>
                                            <h2>{activeRoutes.reduce((sum, v) => sum + Number(v.Routes[0].total_distance_km || 0), 0).toFixed(1)} km</h2>
                                        </div>
                                        <div style={{ textAlign: 'center' }}>
                                            <span style={{ color: 'var(--text-muted)' }}>Vehicles Used:</span>
                                            <h2>{activeRoutes.length}</h2>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};

export default AdminDashboard;
\n\n\n==================================================\nFILE: client\src\pages\Login.jsx\n==================================================\n\nimport { useState, useContext } from 'react';
import { useNavigate } from 'react-router-dom';
import AuthContext from '../context/AuthContext';
import { toast } from 'react-toastify';

import bgImage from '../assets/360_F_677186002_MfKCwdI6SIv3pfgcrXoIvxTHDueDpKNc.jpg';

const Login = () => {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const { login } = useContext(AuthContext);
    const navigate = useNavigate();

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await login(username, password);
            toast.success('Login successful!');
            const user = JSON.parse(localStorage.getItem('user'));
            if (user.role === 'admin') {
                navigate('/admin');
            } else {
                navigate('/dashboard');
            }
        } catch (err) {
            toast.error(err.response?.data?.message || 'Login failed');
        }
    };

    return (
        <div className="flex justify-center items-center" style={{ position: 'relative', overflow: 'hidden', height: '100vh', width: '100vw' }}>
            <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                height: '100%',
                backgroundImage: `url(${bgImage})`,
                backgroundSize: 'cover',
                backgroundPosition: 'center',
                filter: 'blur(8px)',
                zIndex: -1
            }} />
            <div className="card glass" style={{ width: '90%', maxWidth: '400px', zIndex: 1, padding: '2rem' }}>
                <h2 style={{ textAlign: 'center', marginBottom: '2rem' }}>Welcome Back</h2>
                <form onSubmit={handleSubmit} className="flex flex-col">
                    <label>Username</label>
                    <input
                        type="text"
                        placeholder="Username"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        required
                    />
                    <label>Password</label>
                    <input
                        type="password"
                        placeholder="Password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        required
                    />
                    <button type="submit" className="btn-primary" style={{ marginTop: '1rem' }}>
                        Login
                    </button>
                </form>
            </div>
        </div>
    );
};

export default Login;
\n\n\n==================================================\nFILE: client\src\pages\Register.jsx\n==================================================\n\nimport { useState, useContext } from 'react';
import { useNavigate } from 'react-router-dom';
import AuthContext from '../context/AuthContext';
import { toast } from 'react-toastify';

import bgImage from '../assets/360_F_677186002_MfKCwdI6SIv3pfgcrXoIvxTHDueDpKNc.jpg';

const Register = () => {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [role, setRole] = useState('user');
    const { register } = useContext(AuthContext);
    const navigate = useNavigate();

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await register(username, password, role);
            toast.success('Registration successful! Please login.');
            navigate('/login');
        } catch (err) {
            toast.error(err.response?.data?.message || 'Registration failed');
        }
    };

    return (
        <div className="flex justify-center items-center" style={{ position: 'relative', overflow: 'hidden', height: '100vh', width: '100vw' }}>
            <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                height: '100%',
                backgroundImage: `url(${bgImage})`,
                backgroundSize: 'cover',
                backgroundPosition: 'center',
                filter: 'blur(8px)',
                zIndex: -1
            }} />
            <div className="card glass" style={{ width: '90%', maxWidth: '400px', zIndex: 1, padding: '2rem' }}>
                <h2 style={{ textAlign: 'center', marginBottom: '2rem' }}>Create Account</h2>
                <form onSubmit={handleSubmit} className="flex flex-col">
                    <label>Username</label>
                    <input
                        type="text"
                        placeholder="Username"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        required
                    />
                    <label>Password</label>
                    <input
                        type="password"
                        placeholder="Password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        required
                    />
                    <label>Role</label>
                    <select value={role} onChange={(e) => setRole(e.target.value)}>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>

                    <button type="submit" className="btn-primary" style={{ marginTop: '1rem' }}>
                        Register
                    </button>
                </form>
            </div>
        </div>
    );
};

export default Register;
\n\n\n==================================================\nFILE: client\src\pages\UserDashboard.jsx\n==================================================\n\nimport { useState, useEffect } from 'react';
import stationService from '../services/stationService';
import cargoService from '../services/cargoService';
import { toast } from 'react-toastify';

const UserDashboard = () => {
    const [stations, setStations] = useState([]);
    const [cargos, setCargos] = useState([]);
    const [formData, setFormData] = useState({
        station_id: '',
        weight_kg: '',
        request_date: ''
    });
    const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]); // Default today

    useEffect(() => {
        fetchStations();
        fetchCargos();
    }, [filterDate]); // Refetch when filter date changes

    const fetchStations = async () => {
        try {
            const data = await stationService.getStations();
            setStations(data);
        } catch (error) {
            toast.error('Failed to load stations');
        }
    };

    const fetchCargos = async () => {
        try {
            const data = await cargoService.getAllCargos(filterDate);
            setCargos(data);
        } catch (error) {
            toast.error('Failed to load cargo history');
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await cargoService.createCargo(formData);
            toast.success(formData.count > 1 ? `${formData.count} cargos created!` : 'Cargo request created!');
            setFormData({ station_id: '', weight_kg: '', request_date: '', count: '' });
            fetchCargos(); // Refresh list
        } catch (error) {
            toast.error(error.response?.data?.message || 'Failed to create request');
        }
    };

    return (
        <div className="container">
            <h2>User Dashboard</h2>

            <div className="flex flex-col gap-4">
                {/* Request Form */}
                <div className="card glass">
                    <h3>New Cargo Request</h3>
                    <form onSubmit={handleSubmit}>
                        <label>Select Destination Station</label>
                        <select
                            value={formData.station_id}
                            onChange={(e) => setFormData({ ...formData, station_id: e.target.value })}
                            required
                        >
                            <option value="">-- Select Station --</option>
                            {stations.map(station => (
                                <option key={station.id} value={station.id}>
                                    {station.name}
                                </option>
                            ))}
                        </select>

                        <label>Weight (kg)</label>
                        <input
                            type="number"
                            placeholder="Weight"
                            value={formData.weight_kg}
                            onChange={(e) => setFormData({ ...formData, weight_kg: e.target.value })}
                            required
                            min="1"
                        />

                        <label>Count (Optional)</label>
                        <input
                            type="number"
                            placeholder="Count (Default: 1)"
                            value={formData.count || ''}
                            onChange={(e) => setFormData({ ...formData, count: e.target.value })}
                            min="1"
                        />

                        <label>Request Date</label>
                        <input
                            type="date"
                            value={formData.request_date}
                            onChange={(e) => setFormData({ ...formData, request_date: e.target.value })}
                            required
                        />

                        <button type="submit" className="btn-primary" style={{ marginTop: '1rem' }}>
                            Submit Request
                        </button>
                    </form>
                </div>

                {/* Cargo History */}
                <div className="card glass">
                    <div className="flex justify-between items-center mb-4">
                        <h3>My Cargo History</h3>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <label style={{ margin: 0 }}>Filter Date:</label>
                            <input
                                type="date"
                                value={filterDate}
                                onChange={(e) => setFilterDate(e.target.value)}
                                style={{
                                    padding: '0.25rem',
                                    borderRadius: '4px',
                                    border: '1px solid var(--border)',
                                    background: 'rgba(255,255,255,0.05)',
                                    color: 'var(--text)'
                                }}
                            />
                        </div>
                    </div>
                    <div style={{ overflowX: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '1rem' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid var(--border)', textAlign: 'left' }}>
                                    <th style={{ padding: '0.5rem' }}>Date</th>
                                    <th style={{ padding: '0.5rem' }}>Details</th>
                                    <th style={{ padding: '0.5rem' }}>Station</th>
                                    <th style={{ padding: '0.5rem' }}>Weight</th>
                                    <th style={{ padding: '0.5rem' }}>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {cargos.length === 0 ? (
                                    <tr>
                                        <td colSpan="5" style={{ padding: '1rem', textAlign: 'center', color: 'var(--text-muted)' }}>
                                            No cargo requests found.
                                        </td>
                                    </tr>
                                ) : (
                                    cargos.map(cargo => (
                                        <tr key={cargo.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                            <td style={{ padding: '0.5rem' }}>{cargo.request_date}</td>
                                            <td style={{ padding: '0.5rem' }}>Request #{cargo.id}</td>
                                            <td style={{ padding: '0.5rem' }}>{cargo.Station ? cargo.Station.name : '-'}</td>
                                            <td style={{ padding: '0.5rem' }}>{cargo.weight_kg} kg</td>
                                            <td style={{ padding: '0.5rem' }}>
                                                <span style={{
                                                    padding: '0.25rem 0.5rem',
                                                    borderRadius: '4px',
                                                    fontSize: '0.875rem',
                                                    background: cargo.status === 'pending' ? 'rgba(251, 191, 36, 0.2)' : 'rgba(16, 185, 129, 0.2)',
                                                    color: cargo.status === 'pending' ? '#fbbf24' : '#10b981'
                                                }}>
                                                    {cargo.status}
                                                </span>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default UserDashboard;
\n\n\n==================================================\nFILE: client\src\services\api.js\n==================================================\n\nimport axios from 'axios';

const api = axios.create({
  baseURL: 'http://localhost:5000/api', // Backend base URL
});

// Request interceptor to add the auth token to headers
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers['x-auth-token'] = token;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

export default api;
\n\n\n==================================================\nFILE: client\src\services\authService.js\n==================================================\n\nimport api from './api';

const login = async (username, password) => {
    const response = await api.post('/auth/login', { username, password });
    if (response.data.token) {
        localStorage.setItem('token', response.data.token);
        localStorage.setItem('user', JSON.stringify(response.data.user));
    }
    return response.data;
};

const register = async (username, password, role) => {
    const response = await api.post('/auth/register', { username, password, role });
    return response.data;
};

const logout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
};

const getCurrentUser = () => {
    return JSON.parse(localStorage.getItem('user'));
};

const authService = {
    login,
    register,
    logout,
    getCurrentUser,
};

export default authService;
\n\n\n==================================================\nFILE: client\src\services\cargoService.js\n==================================================\n\nimport api from './api';

const getAllCargos = async (date = null) => {
    const params = date ? { date } : {};
    const response = await api.get('/cargos', { params });
    return response.data;
};

const createCargo = async (cargoData) => {
    const response = await api.post('/cargos', cargoData);
    return response.data;
};

const bulkCreateCargos = async (cargos) => {
    const response = await api.post('/cargos/bulk', { cargos });
    return response.data;
};

const deleteAllCargos = async () => {
    const response = await api.delete('/cargos');
    return response.data;
};

const cargoService = {
    getAllCargos,
    createCargo,
    bulkCreateCargos,
    deleteAllCargos,
};

export default cargoService;
\n\n\n==================================================\nFILE: client\src\services\optimizationService.js\n==================================================\n\nimport api from './api';

const optimizeRoutes = async (cargoIds = [], mode = 'unlimited', date = null) => {
    const response = await api.post('/optimize', { cargoIds, mode, date });
    return response.data;
};

const analyzeAllScenarios = async (date = null) => {
    const response = await api.post('/analyze', { date });
    return response.data;
};

const optimizationService = {
    optimizeRoutes,
    analyzeAllScenarios,
};

export default optimizationService;
\n\n\n==================================================\nFILE: client\src\services\routingService.js\n==================================================\n\nimport axios from 'axios';

const OSRM_BASE_URL = 'http://router.project-osrm.org/route/v1/driving';

const routingService = {
    /**
     * Fetches the driving route between two coordinates using OSRM.
     * @param {number} startLat 
     * @param {number} startLon 
     * @param {number} endLat 
     * @param {number} endLon 
     * @returns {Promise<Array<{latitude: number, longitude: number}>>} Array of coordinates for the route path
     */
    getRoute: async (startLat, startLon, endLat, endLon) => {
        try {
            // OSRM expects "lon,lat" format
            const url = `${OSRM_BASE_URL}/${startLon},${startLat};${endLon},${endLat}?overview=full&geometries=geojson`;
            const response = await axios.get(url);

            if (response.data.code === 'Ok' && response.data.routes.length > 0) {
                const coordinates = response.data.routes[0].geometry.coordinates;
                // Convert [lon, lat] to {latitude, longitude}
                return coordinates.map(coord => ({
                    latitude: coord[1],
                    longitude: coord[0]
                }));
            }
            return null;
        } catch (error) {
            console.error('Error fetching route from OSRM:', error);
            return null;
        }
    }
};

export default routingService;
\n\n\n==================================================\nFILE: client\src\services\stationService.js\n==================================================\n\nimport api from './api';

const getStations = async () => {
    const response = await api.get('/stations');
    return response.data;
};

const addStation = async (station) => {
    const response = await api.post('/stations', station);
    return response.data;
};

const stationService = {
    getStations,
    addStation,
};

export default stationService;
\n\n\n==================================================\nFILE: client\src\services\vehicleService.js\n==================================================\n\nimport api from './api';

const getVehicles = async () => {
    const response = await api.get('/vehicles');
    return response.data;
};

const addVehicle = async (vehicleData) => {
    const response = await api.post('/vehicles', vehicleData);
    return response.data;
};

const getVehicleRoutes = async (date) => {
    const response = await api.get(`/vehicles/routes?date=${date}`);
    return response.data;
};

const updateVehicleStatus = async (id, status) => {
    const response = await api.put(`/vehicles/${id}/status`, { status });
    return response.data;
};

const vehicleService = {
    getVehicles,
    addVehicle,
    getVehicleRoutes,
    updateVehicleStatus
};

export default vehicleService;
\n\n\n==================================================\nFILE: backend\config\db.js\n==================================================\n\nconst { Sequelize } = require('sequelize');
require('dotenv').config();

// Veritabanı bağlantı ayarları (.env dosyasından okur)
const sequelize = new Sequelize(
    process.env.DB_NAME,
    process.env.DB_USER,
    process.env.DB_PASSWORD,
    {
        host: process.env.DB_HOST,
        dialect: process.env.DB_DIALECT,
        logging: false, // Konsolun SQL sorgularıyla dolmaması için false yaptık
        pool: {
            max: 5,
            min: 0,
            acquire: 30000,
            idle: 10000
        }
    }
);

// Bağlantıyı test etme fonksiyonu
const connectDB = async () => {
    try {
        await sequelize.authenticate();
        console.log('✅ MySQL Veritabanı Bağlantısı Başarılı!');
    } catch (error) {
        console.error('❌ Veritabanı Bağlantı Hatası:', error);
        process.exit(1); // Hata varsa uygulamayı durdur
    }
};

module.exports = { sequelize, connectDB };\n\n\n==================================================\nFILE: backend\controllers\authController.js\n==================================================\n\nconst bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const { User } = require('../models');

// KULLANICI KAYDI (REGISTER)
exports.register = async (req, res) => {
    try {
        const { username, password, role } = req.body;

        // Kullanıcı var mı kontrol et
        const existingUser = await User.findOne({ where: { username } });
        if (existingUser) {
            return res.status(400).json({ message: 'Bu kullanıcı adı zaten alınmış.' });
        }

        // Şifreyi şifrele (Hash)
        const hashedPassword = await bcrypt.hash(password, 10);

        // Yeni kullanıcı oluştur
        const newUser = await User.create({
            username,
            password: hashedPassword,
            role: role || 'user' // Eğer rol gelmezse standart user yap
        });

        res.status(201).json({ message: 'Kullanıcı başarıyla oluşturuldu.' });
    } catch (error) {
        res.status(500).json({ message: 'Sunucu hatası', error: error.message });
    }
};

// GİRİŞ YAPMA (LOGIN)
exports.login = async (req, res) => {
    try {
        const { username, password } = req.body;

        // Kullanıcıyı bul
        const user = await User.findOne({ where: { username } });
        if (!user) {
            return res.status(400).json({ message: 'Kullanıcı adı veya şifre hatalı.' });
        }

        // Şifreyi kontrol et
        const isMatch = await bcrypt.compare(password, user.password);
        if (!isMatch) {
            return res.status(400).json({ message: 'Kullanıcı adı veya şifre hatalı.' });
        }

        // Token oluştur (Bu token ile diğer işlemleri yapacak)
        const token = jwt.sign(
            { id: user.id, role: user.role },
            process.env.JWT_SECRET,
            { expiresIn: '1d' } // 1 gün geçerli
        );

        res.json({
            message: 'Giriş başarılı',
            token,
            user: { id: user.id, username: user.username, role: user.role }
        });

    } catch (error) {
        res.status(500).json({ message: 'Sunucu hatası', error: error.message });
    }
};\n\n\n==================================================\nFILE: backend\controllers\cargoController.js\n==================================================\n\nconst { Cargo, Station, User } = require('../models');

// KARGO EKLEME (Kullanıcı Paneli İçin)
// KARGO EKLEME (Kullanıcı Paneli İçin)
exports.createCargo = async (req, res) => {
    try {
        // req.user, auth middleware'inden gelecek (giriş yapan kullanıcı)
        const userId = req.user.id;
        const { station_id, weight_kg, request_date, count } = req.body;

        const cargoCount = parseInt(count) || 1;

        if (cargoCount > 1) {
            // Batch create
            const cargoArray = [];
            for (let i = 0; i < cargoCount; i++) {
                cargoArray.push({
                    user_id: userId,
                    station_id,
                    weight_kg,
                    request_date: request_date || new Date(),
                    status: 'pending'
                });
            }
            const createdCargos = await Cargo.bulkCreate(cargoArray);
            return res.status(201).json({ message: `${cargoCount} adet kargo talebi alındı.`, data: createdCargos });
        } else {
            // Single create
            const newCargo = await Cargo.create({
                user_id: userId,
                station_id,
                weight_kg,
                request_date: request_date || new Date(),
                status: 'pending'
            });
            return res.status(201).json({ message: 'Kargo talebi alındı.', data: newCargo });
        }

    } catch (error) {
        res.status(500).json({ message: 'Kargo eklenirken hata oluştu.', error: error.message });
    }
};

// KARGOLARI LİSTELEME
exports.getAllCargos = async (req, res) => {
    try {
        // Eğer admin ise hepsini görsün, değilse sadece kendininkini
        const whereClause = req.user.role === 'admin' ? {} : { user_id: req.user.id };

        // Tarih filtresi (Opsiyonel)
        if (req.query.date) {
            whereClause.request_date = req.query.date;
        }

        const cargos = await Cargo.findAll({
            where: whereClause,
            include: [
                { model: Station, attributes: ['name'] }, // İstasyon adını getir
                { model: User, attributes: ['username'] } // Kimin gönderdiğini getir
            ],
            order: [['request_date', 'DESC']]
        });

        res.json(cargos);

    } catch (error) {
        res.status(500).json({ message: 'Kargolar getirilemedi.', error: error.message });
    }
};

// BULK CREATE (Senaryolar İçin)
exports.bulkCreateCargos = async (req, res) => {
    try {
        const userId = req.user.id;
        const { cargos } = req.body; // Array of { station_id, weight_kg, request_date, status }

        // Assign user_id to all
        const cargosWithUser = cargos.map(c => ({
            ...c,
            user_id: userId,
            status: 'pending'
        }));

        const createdCargos = await Cargo.bulkCreate(cargosWithUser);
        res.status(201).json({ message: 'Toplu kargo eklendi.', count: createdCargos.length });

    } catch (error) {
        res.status(500).json({ message: 'Toplu kargo eklenirken hata oluştu.', error: error.message });
    }
};

// DELETE ALL (Senaryo Sıfırlama İçin)
exports.deleteAllCargos = async (req, res) => {
    try {
        // Sadece admin yapabilmeli (routeda kontrol edilecek)
        await Cargo.destroy({
            where: {},
            truncate: true // ID'leri de sıfırlayabilir (sqlite'da değişir)
        });
        res.json({ message: 'Tüm kargolar silindi.' });
    } catch (error) {
        res.status(500).json({ message: 'Kargolar silinemedi.', error: error.message });
    }
};\n\n\n==================================================\nFILE: backend\controllers\optimizationController.js\n==================================================\n\nconst { Station, Vehicle, Cargo, Route, RouteStop, CargoVehicle, sequelize, User } = require('../models');
const geolib = require('geolib');
const OptimizationService = require('../services/optimizationService');

// --- HELPER: Distance Matrix ---
const createDistanceMatrix = (stations) => {
    const matrix = {};
    stations.forEach(source => {
        matrix[source.id] = {};
        stations.forEach(target => {
            if (source.id === target.id) {
                matrix[source.id][target.id] = 0;
            } else {
                const distanceMeters = geolib.getDistance(
                    { latitude: source.latitude, longitude: source.longitude },
                    { latitude: target.latitude, longitude: target.longitude }
                );
                matrix[source.id][target.id] = distanceMeters / 1000;
            }
        });
    });
    return matrix;
};

// --- HELPER: Solve TSP (Nearest Neighbor) ---
const solveTSP = (startStationId, stationsToVisit, distanceMatrix) => {
    let currentStationId = startStationId;
    const path = [];
    const unvisited = Array.from(stationsToVisit);

    while (unvisited.length > 0) {
        let nearestStation = null;
        let minDist = Infinity;
        let indexToRemove = -1;

        unvisited.forEach((stationId, index) => {
            const sId = parseInt(stationId);
            const dist = distanceMatrix[currentStationId][sId];
            if (dist < minDist) {
                minDist = dist;
                nearestStation = sId;
                indexToRemove = index;
            }
        });

        if (nearestStation) {
            path.push({ stationId: nearestStation, distanceFromPrev: minDist });
            currentStationId = nearestStation;
            unvisited.splice(indexToRemove, 1);
        } else {
            break;
        }
    }
    return path;
};

// --- HELPER: Cluster Stations (Simple Radius Clustering) ---
const clusterCargosByLocation = (cargos, stations, radiusKm = 10) => {
    const clusters = [];
    // Station Map for fast lookup
    const stationMap = new Map(stations.map(s => [s.id, s]));

    // Group cargos by Station ID first
    const stationCargos = {};
    cargos.forEach(c => {
        if (!stationCargos[c.station_id]) stationCargos[c.station_id] = [];
        stationCargos[c.station_id].push(c);
    });

    const activeStationIds = Object.keys(stationCargos).map(id => parseInt(id));
    const visitedStations = new Set();

    activeStationIds.forEach(centerStationId => {
        if (visitedStations.has(centerStationId)) return;

        const cluster = {
            stationIds: [centerStationId],
            cargos: [...stationCargos[centerStationId]],
            totalWeight: stationCargos[centerStationId].reduce((sum, c) => sum + c.weight_kg, 0)
        };
        visitedStations.add(centerStationId);

        const centerStation = stationMap.get(centerStationId);

        // Look for neighbors
        activeStationIds.forEach(neighborId => {
            if (visitedStations.has(neighborId)) return;
            const neighbor = stationMap.get(neighborId);

            const distMeters = geolib.getDistance(
                { latitude: centerStation.latitude, longitude: centerStation.longitude },
                { latitude: neighbor.latitude, longitude: neighbor.longitude }
            );

            if (distMeters / 1000 <= radiusKm) {
                cluster.stationIds.push(neighborId);
                cluster.cargos.push(...stationCargos[neighborId]);
                cluster.totalWeight += stationCargos[neighborId].reduce((sum, c) => sum + c.weight_kg, 0);
                visitedStations.add(neighborId);
            }
        });

        clusters.push(cluster);
    });

    return clusters.sort((a, b) => b.totalWeight - a.totalWeight); // Return heaviest clusters first
};


// --- CORE OPTIMIZATION LOGIC (Reusable) ---
const runOptimizationLogic = async (date, options, transaction) => {
    const { allowRentals = true, sortOrder = 'DESC' } = options;
    const todayStr = date || new Date().toISOString().split('T')[0];

    // 1. Fetch Resources
    const pendingCargos = await Cargo.findAll({
        where: { status: 'pending', request_date: todayStr },
        include: [{ model: User, attributes: ['username'] }],
        order: [['weight_kg', sortOrder]]
    });
    const stations = await Station.findAll();
    const centerStation = stations.find(s => s.is_center);

    // 2. Fetch Active Vehicles (Owned only initially)
    let activeVehicles = await Vehicle.findAll({
        where: { status: 'active', is_rental: false },
        order: [['capacity_kg', 'DESC']]
    });

    if (!centerStation) throw new Error("Center station not found");
    if (pendingCargos.length === 0) {
        return { totalRoutes: 0, routes: [], stats: { totalCost: 0, totalDistance: 0, vehicleCount: 0, totalWeight: 0 } };
    }

    const distanceMatrix = createDistanceMatrix(stations);
    const createdRoutes = [];

    // 3. Cluster Cargos
    const clusters = clusterCargosByLocation(pendingCargos, stations, 15);

    // 4. Assign Clusters to Vehicles
    const vehicleAssignments = [];

    // Initialize Owned Vehicles
    activeVehicles.forEach(v => {
        vehicleAssignments.push({
            vehicle: v,
            cargos: [],
            currentLoad: 0,
            stations: new Set(),
            isRental: false
        });
    });

    for (const cluster of clusters) {
        let clusterCargos = [...cluster.cargos];

        while (clusterCargos.length > 0) {
            let bestVehicleIndex = -1;
            let maxFill = -1;
            const minCargoWeight = Math.min(...clusterCargos.map(c => c.weight_kg));

            // Try owned/active vehicles
            for (let i = 0; i < vehicleAssignments.length; i++) {
                const va = vehicleAssignments[i];
                const remainingCap = va.vehicle.capacity_kg - va.currentLoad;
                if (remainingCap < minCargoWeight) continue;

                // COST CHECK FOR RENTALS:
                // If reusing this rental means traveling > 200km (200TL), it's cheaper to get a NEW rental (200TL base).
                if (va.isRental && va.stations.size > 0 && clusterCargos.length > 0) {
                    // Estimate distance from last stop to new cluster start
                    const lastStationId = Array.from(va.stations).pop(); // Simple proxy
                    const nextStationId = clusterCargos[0].station_id;

                    const distKm = distanceMatrix[lastStationId][nextStationId];
                    const detourCost = distKm * va.vehicle.fuel_cost_per_km;

                    // If detour is more expensive than a new rental base cost (200), SKIP this vehicle.
                    // (Unless new rental also has high delivery cost? roughly new rental cost = 200 + local delivery.
                    // Reuse rental cost = Detour + local delivery. So we compare Detour vs 200.)
                    if (detourCost > 200) continue;
                }

                // If valid, prefer the one with best fit (max remaining capacity that fits?? or min waste?)
                // Strategy: Fill largest gaps? Or tightest fit?
                // Logic: "maxFill" selects the vehicle with MOST remaining capacity.
                if (remainingCap > maxFill) {
                    maxFill = remainingCap;
                    bestVehicleIndex = i;
                }
            }

            if (bestVehicleIndex !== -1) {
                const va = vehicleAssignments[bestVehicleIndex];
                let assignedCount = 0;
                for (let k = 0; k < clusterCargos.length; k++) {
                    if (va.currentLoad + clusterCargos[k].weight_kg <= va.vehicle.capacity_kg) {
                        va.cargos.push(clusterCargos[k]);
                        va.currentLoad += clusterCargos[k].weight_kg;
                        va.stations.add(clusterCargos[k].station_id);
                        clusterCargos.splice(k, 1);
                        k--;
                        assignedCount++;
                    }
                }
                if (assignedCount === 0) bestVehicleIndex = -1;
            }

            if (bestVehicleIndex === -1) {
                // RENTAL LOGIC
                if (allowRentals) {
                    while (clusterCargos.length > 0) {
                        const rentalCount = vehicleAssignments.filter(v => v.isRental).length + 1;
                        const nextCargo = clusterCargos[0];
                        const neededForSingleItem = nextCargo.weight_kg;
                        const rentalCapacity = Math.max(500, neededForSingleItem);

                        const rentalVehicle = await Vehicle.create({
                            plate_number: `RENT-${Date.now().toString().slice(-4)}-${rentalCount}`,
                            capacity_kg: rentalCapacity,
                            base_cost: 200,
                            fuel_cost_per_km: 1.0,
                            is_rental: true,
                            status: 'active'
                        }, { transaction });

                        const newAssignment = {
                            vehicle: rentalVehicle,
                            cargos: [],
                            currentLoad: 0,
                            stations: new Set(),
                            isRental: true
                        };
                        vehicleAssignments.push(newAssignment);

                        let assignedToThisRental = 0;
                        for (let k = 0; k < clusterCargos.length; k++) {
                            if (newAssignment.currentLoad + clusterCargos[k].weight_kg <= rentalVehicle.capacity_kg) {
                                newAssignment.cargos.push(clusterCargos[k]);
                                newAssignment.currentLoad += clusterCargos[k].weight_kg;
                                newAssignment.stations.add(clusterCargos[k].station_id);
                                clusterCargos.splice(k, 1);
                                k--;
                                assignedToThisRental++;
                            }
                        }
                        if (assignedToThisRental === 0) break; // prevent infinite
                    }
                } else {
                    // Rentals NOT allowed. Skip remaining cargos in this cluster.
                    // Instead of breaking infinite loop, we just stop processing this cluster because no vehicle fits.
                    // But we must EMPTY the clusterCargos array so the outer while loop breaks?
                    // Or maintain a list of 'unassigned' cargos?
                    // For simulation stats, we just ignore them.
                    clusterCargos = []; // Abandon remaining items
                }
            }
        }
    }

    // 5. Commit Assignments & Create Routes
    let totalCost = 0;
    let totalDist = 0;
    let totalWeight = 0;

    for (const va of vehicleAssignments) {
        if (va.cargos.length === 0) continue;

        // A. Create CargoVehicle
        for (const c of va.cargos) {
            await CargoVehicle.create({
                vehicle_id: va.vehicle.id,
                cargo_id: c.id,
                route_date: todayStr
            }, { transaction });

            // IMPORTANT: For simulation, we updated the memory object, but let's update DB too so logic holds (will rollback anyway)
            await Cargo.update({ status: 'planned' }, { where: { id: c.id }, transaction });
        }

        // B. Optimize Route (TSP)
        const sortedPath = solveTSP(centerStation.id, va.stations, distanceMatrix);
        let routeDist = 0;
        sortedPath.forEach(p => routeDist += p.distanceFromPrev);
        if (sortedPath.length > 0) {
            const lastId = sortedPath[sortedPath.length - 1].stationId;
            routeDist += distanceMatrix[lastId][centerStation.id];
        }

        const routeCost = OptimizationService.calculateRouteCost(va.vehicle, routeDist);

        const newRoute = await Route.create({
            vehicle_id: va.vehicle.id,
            route_date: todayStr,
            total_distance_km: routeDist,
            total_cost: routeCost
        }, { transaction });

        // C. Create Stops
        let visitOrder = 1;
        let prevId = centerStation.id;
        for (let i = 0; i < sortedPath.length; i++) {
            const stop = sortedPath[i];
            await RouteStop.create({
                route_id: newRoute.id,
                station_id: stop.stationId,
                previous_station_id: prevId,
                next_station_id: (i < sortedPath.length - 1) ? sortedPath[i + 1].stationId : centerStation.id,
                vehicle_id: va.vehicle.id,
                visit_order: visitOrder++,
                operation_type: 'dropoff'
            }, { transaction });
            prevId = stop.stationId;
        }

        totalCost += routeCost;
        totalDist += routeDist;
        totalWeight += va.currentLoad;

        // D. Construct Path for Frontend Map
        const path = [];
        const centerCoords = { latitude: centerStation.latitude, longitude: centerStation.longitude };
        const getCoords = (id) => {
            const s = stations.find(st => st.id === id);
            return s ? { latitude: s.latitude, longitude: s.longitude } : centerCoords;
        };

        path.push(centerCoords); // Start
        sortedPath.forEach(p => path.push(getCoords(p.stationId))); // Visits
        path.push(centerCoords); // Return

        createdRoutes.push({
            ...newRoute.dataValues,
            vehiclePlate: va.vehicle.plate_number,
            cargos: va.cargos,
            isRental: va.isRental,
            path: path // <--- Added for Map.jsx
        });
    }

    return {
        totalRoutes: createdRoutes.length,
        routes: createdRoutes,
        stats: {
            totalCost,
            totalDistance: totalDist,
            totalWeight,
            vehicleCount: createdRoutes.length
        }
    };
};

// --- MAIN CONTROLLER (Active Optimization) ---
exports.optimizeRoutes = async (req, res) => {
    const transaction = await sequelize.transaction();
    try {
        console.log("🚀 Starting Active Optimization...");
        const result = await runOptimizationLogic(req.body.date, { allowRentals: true, sortOrder: 'DESC' }, transaction);

        // This is a REAL run, so we commit
        await transaction.commit();

        const getCoords = (id) => { /* Helper if needed, skipping for brevity in response */ };
        // Logic to format response same as before could go here, but client generally just reloads active routes.
        // We will return success.

        res.status(200).json({
            success: true,
            message: 'Optimization completed and saved to database.',
            data: result
        });
    } catch (error) {
        await transaction.rollback();
        console.error("Optimization Failed:", error);
        res.status(500).json({ message: "Optimization Failed", error: error.message });
    }
};

// --- NEW: ANALYZE ALL SCENARIOS ---
exports.analyzeAllScenarios = async (req, res) => {
    try {
        console.log("📊 Analyzing All Scenarios...");
        const { date } = req.body;
        const todayStr = date || new Date().toISOString().split('T')[0];

        // SCENARIO A: Unlimited (Standard)
        const t1 = await sequelize.transaction();
        const sc1 = await runOptimizationLogic(date, { allowRentals: true, sortOrder: 'DESC' }, t1);
        await t1.rollback();

        // SCENARIO B: Fixed Count (No Rentals)
        const t2 = await sequelize.transaction();
        const sc2 = await runOptimizationLogic(date, { allowRentals: false, sortOrder: 'DESC' }, t2);
        await t2.rollback();

        // SCENARIO C: Fixed Weight (No Rentals, Sort ASC)
        const t3 = await sequelize.transaction();
        const sc3 = await runOptimizationLogic(date, { allowRentals: false, sortOrder: 'ASC' }, t3);
        await t3.rollback();

        res.json({
            unlimited: sc1.stats,
            fixed_count: sc2.stats,
            fixed_weight: sc3.stats
        });

    } catch (error) {
        console.error("Analysis Failed:", error);
        res.status(500).json({ message: "Analysis Failed", error: error.message });
    }
};\n\n\n==================================================\nFILE: backend\controllers\stationController.js\n==================================================\n\nconst { Station } = require('../models');

// TÜM İSTASYONLARI GETİR
exports.getStations = async (req, res) => {
    try {
        const stations = await Station.findAll();
        res.json(stations);
    } catch (error) {
        res.status(500).json({ message: 'İstasyonlar alınamadı.', error: error.message });
    }
};

// İSTASYON EKLE
exports.createStation = async (req, res) => {
    try {
        const { name, latitude, longitude } = req.body;
        const newStation = await Station.create({ name, latitude, longitude });
        res.status(201).json(newStation);
    } catch (error) {
        res.status(500).json({ message: 'İstasyon eklenemedi.', error: error.message });
    }
};\n\n\n==================================================\nFILE: backend\controllers\vehicleController.js\n==================================================\n\nconst { Vehicle, Route, RouteStop, Station, Cargo, User } = require('../models');
const OptimizationService = require('../services/optimizationService');

exports.getVehicles = async (req, res) => {
    try {
        const vehicles = await Vehicle.findAll();
        res.json(vehicles);
    } catch (error) {
        res.status(500).json({ message: 'Error fetching vehicles', error: error.message });
    }
};

exports.addVehicle = async (req, res) => {
    try {
        const { plate_number, capacity_kg, base_cost, fuel_cost_per_km } = req.body;
        const newVehicle = await Vehicle.create({
            plate_number,
            capacity_kg,
            base_cost: base_cost || 0,
            fuel_cost_per_km: fuel_cost_per_km || 1,
            is_rental: false // Admin tarafından eklenenler kiralık değil sabit araçtır
        });
        res.status(201).json(newVehicle);
    } catch (error) {
        res.status(500).json({ message: 'Error adding vehicle', error: error.message });
    }
};

exports.optimizeFleet = async (req, res) => {
    try {
        const { totalWeightKg, distanceKm } = req.body;

        if (!totalWeightKg || !distanceKm) {
            return res.status(400).json({ message: 'Total weight and distance are required' });
        }

        const result = await OptimizationService.optimizeFleet(totalWeightKg, distanceKm);
        res.json(result);
    } catch (error) {
        res.status(500).json({ message: 'Error calculating fleet optimization', error: error.message });
    }
};

exports.getVehicleRoutes = async (req, res) => {
    try {
        const { date } = req.query;
        console.log("Fetching routes for date:", date);

        const whereClause = {};
        if (date) {
            whereClause.route_date = date;
        }

        // Fetch Vehicles that have Routes for this date
        // We include Route -> RouteStop -> Station
        // AND Cargo (via CargoVehicle filtered by date) to get weights
        const vehicles = await Vehicle.findAll({
            include: [
                {
                    model: Route,
                    required: true, // Only vehicles WITH routes
                    where: whereClause,
                    include: [{
                        model: RouteStop,
                        include: [
                            { model: Station, as: 'Station' },
                            { model: Station, as: 'PreviousStation' },
                            { model: Station, as: 'NextStation' }
                        ]
                    }]
                },
                {
                    model: Cargo,
                    through: {
                        where: { route_date: date }
                    },
                    include: [{ model: User, attributes: ['username'] }]
                }
            ]
        });

        console.log(`Found ${vehicles.length} vehicles with routes.`);

        // Sort stops strictly in JS if needed, but DB order is usually insertion. 
        // Better to sort by visit_order
        const result = vehicles.map(v => {
            const vehicleJson = v.toJSON();
            // Process routes to sort stops
            if (vehicleJson.Routes) {
                vehicleJson.Routes.forEach(r => {
                    if (r.RouteStops) {
                        r.RouteStops.sort((a, b) => a.visit_order - b.visit_order);
                    }
                });
            }
            return vehicleJson;
        });

        res.json(result);
    } catch (error) {
        console.error('Error fetching vehicle routes:', error);
        res.status(500).json({ message: 'Error fetching vehicle routes', error: error.message });
    }
};

exports.updateVehicleStatus = async (req, res) => {
    try {
        const { id } = req.params;
        const { status } = req.body;

        if (!['active', 'maintenance'].includes(status)) {
            return res.status(400).json({ message: 'Invalid status' });
        }

        const vehicle = await Vehicle.findByPk(id);
        if (!vehicle) {
            return res.status(404).json({ message: 'Vehicle not found' });
        }

        vehicle.status = status;
        await vehicle.save();

        res.json(vehicle);
    } catch (error) {
        res.status(500).json({ message: 'Error updating vehicle status', error: error.message });
    }
};
\n\n\n==================================================\nFILE: backend\middleware\authMiddleware.js\n==================================================\n\nconst jwt = require('jsonwebtoken');

module.exports = (req, res, next) => {
    // Header'dan token'ı al
    const token = req.header('x-auth-token');

    // Token yoksa durdur
    if (!token) {
        return res.status(401).json({ message: 'Yetkisiz erişim. Token yok.' });
    }

    try {
        // Token'ı çöz
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        req.user = decoded; // Kullanıcı bilgisini request'e ekle
        next(); // Devam et
    } catch (error) {
        res.status(401).json({ message: 'Token geçersiz.' });
    }
};\n\n\n==================================================\nFILE: backend\models\Cargo.js\n==================================================\n\nconst { DataTypes } = require('sequelize');
const { sequelize } = require('../config/db');

const Cargo = sequelize.define('Cargo', {
    weight_kg: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    status: {
        type: DataTypes.ENUM('pending', 'planned', 'delivered'),
        defaultValue: 'pending'
    },
    request_date: {
        type: DataTypes.DATEONLY,
        defaultValue: DataTypes.NOW
    }
}, {
    tableName: 'cargos',
    timestamps: false
});

module.exports = Cargo;\n\n\n==================================================\nFILE: backend\models\CargoVehicle.js\n==================================================\n\nconst { DataTypes } = require('sequelize');
const { sequelize } = require('../config/db');

const CargoVehicle = sequelize.define('CargoVehicle', {
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    vehicle_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: {
            model: 'vehicles',
            key: 'id'
        }
    },
    cargo_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: {
            model: 'cargos',
            key: 'id'
        }
    },
    route_date: {
        type: DataTypes.DATEONLY,
        allowNull: true
    }
}, {
    tableName: 'cargos_vehicles',
    timestamps: false
});

module.exports = CargoVehicle;
\n\n\n==================================================\nFILE: backend\models\index.js\n==================================================\n\nconst { sequelize } = require('../config/db');

// Modelleri İçe Aktar
const User = require('./User');
const Station = require('./Station');
const Vehicle = require('./Vehicle');
const Cargo = require('./Cargo');
const CargoVehicle = require('./CargoVehicle');
const Route = require('./Route');
const RouteStop = require('./RouteStop');

// --- İLİŞKİLER (ASSOCIATIONS) ---

// 1. Kullanıcı - Kargo İlişkisi
User.hasMany(Cargo, { foreignKey: 'user_id' });
Cargo.belongsTo(User, { foreignKey: 'user_id' });

// 2. İstasyon - Kargo İlişkisi
Station.hasMany(Cargo, { foreignKey: 'station_id' });
Cargo.belongsTo(Station, { foreignKey: 'station_id' });

// 3. Araç - Rota İlişkisi
Vehicle.hasMany(Route, { foreignKey: 'vehicle_id' });
Route.belongsTo(Vehicle, { foreignKey: 'vehicle_id' });

// 4. Rota - Durak İlişkisi
Route.hasMany(RouteStop, { foreignKey: 'route_id' });
RouteStop.belongsTo(Route, { foreignKey: 'route_id' });

// 5. İstasyon - Durak İlişkisi
Station.hasMany(RouteStop, { foreignKey: 'station_id' });
RouteStop.belongsTo(Station, { foreignKey: 'station_id', as: 'Station' }); // Explicit alias might be needed if using 'as' in query, but usually defaults to model name. 
// Wait, in controller we used { model: Station, as: 'Station' }. 
// If generic belongsTo is defined without alias, 'Station' alias works? 
// Code says: RouteStop.belongsTo(Station, { foreignKey: 'station_id' }); 
// In controller: { model: Station, as: 'Station' }. This works if we define it as such or if sequelize auto-aliases.
// Better to be explicit matches.

// Let's add the new ones:
RouteStop.belongsTo(Station, { foreignKey: 'previous_station_id', as: 'PreviousStation' });
RouteStop.belongsTo(Station, { foreignKey: 'next_station_id', as: 'NextStation' });

// 6. Araç - Kargo İlişkisi (Yeni Tablo: cargos_vehicles)
Vehicle.belongsToMany(Cargo, { through: CargoVehicle, foreignKey: 'vehicle_id' });
Cargo.belongsToMany(Vehicle, { through: CargoVehicle, foreignKey: 'cargo_id' });
Cargo.hasMany(CargoVehicle, { foreignKey: 'cargo_id' });
CargoVehicle.belongsTo(Cargo, { foreignKey: 'cargo_id' });
Vehicle.hasMany(CargoVehicle, { foreignKey: 'vehicle_id' });
CargoVehicle.belongsTo(Vehicle, { foreignKey: 'vehicle_id' });

// Modelleri dışarı aktar
module.exports = {
    sequelize,
    User,
    Station,
    Vehicle,
    Cargo,
    Route,
    RouteStop,
    CargoVehicle
};\n\n\n==================================================\nFILE: backend\models\Route.js\n==================================================\n\nconst { DataTypes } = require('sequelize');
const { sequelize } = require('../config/db');

const Route = sequelize.define('Route', {
    route_date: {
        type: DataTypes.DATEONLY,
        allowNull: true
    },
    total_distance_km: {
        type: DataTypes.DECIMAL(10, 2),
        allowNull: true
    },
    total_cost: {
        type: DataTypes.DECIMAL(10, 2),
        allowNull: true
    }
}, {
    tableName: 'routes',
    timestamps: true,
    createdAt: 'calculated_at',
    updatedAt: false
});

module.exports = Route;\n\n\n==================================================\nFILE: backend\models\RouteStop.js\n==================================================\n\nconst { DataTypes } = require('sequelize');
const { sequelize } = require('../config/db');

const RouteStop = sequelize.define('RouteStop', {
    route_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: { model: 'routes', key: 'id' }
    },
    station_id: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: { model: 'stations', key: 'id' }
    },
    vehicle_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        references: { model: 'vehicles', key: 'id' }
    },
    previous_station_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        references: { model: 'stations', key: 'id' }
    },
    next_station_id: {
        type: DataTypes.INTEGER,
        allowNull: true,
        references: { model: 'stations', key: 'id' }
    },
    visit_order: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 1
    },
    operation_type: {
        type: DataTypes.ENUM('pickup', 'dropoff', 'none'),
        defaultValue: 'pickup'
    }
}, {
    tableName: 'route_stops',
    timestamps: false
});

module.exports = RouteStop;\n\n\n==================================================\nFILE: backend\models\Station.js\n==================================================\n\nconst { DataTypes } = require('sequelize');
const { sequelize } = require('../config/db');

const Station = sequelize.define('Station', {
    name: {
        type: DataTypes.STRING,
        allowNull: false
    },
    latitude: {
        type: DataTypes.DECIMAL(10, 8),
        allowNull: false
    },
    longitude: {
        type: DataTypes.DECIMAL(11, 8),
        allowNull: false
    },
    is_center: {
        type: DataTypes.BOOLEAN,
        defaultValue: false
    }
}, {
    tableName: 'stations',
    timestamps: false // İstasyon tablosunda tarih tutmaya gerek duymamıştık
});

module.exports = Station;\n\n\n==================================================\nFILE: backend\models\User.js\n==================================================\n\nconst { DataTypes } = require('sequelize');
const { sequelize } = require('../config/db');

const User = sequelize.define('User', {
    username: {
        type: DataTypes.STRING,
        allowNull: false,
        unique: true
    },
    password: {
        type: DataTypes.STRING,
        allowNull: false
    },
    role: {
        type: DataTypes.ENUM('admin', 'user'),
        defaultValue: 'user'
    }
}, {
    tableName: 'users',
    timestamps: true, // created_at ve updated_at otomatik yönetilir
    createdAt: 'created_at',
    updatedAt: false // SQL tablonda updated_at yoksa bunu false yapabilirsin
});

module.exports = User;\n\n\n==================================================\nFILE: backend\models\Vehicle.js\n==================================================\n\nconst { DataTypes } = require('sequelize');
const { sequelize } = require('../config/db');

const Vehicle = sequelize.define('Vehicle', {
    plate_number: {
        type: DataTypes.STRING,
        allowNull: false
    },
    capacity_kg: {
        type: DataTypes.INTEGER,
        allowNull: false
    },
    base_cost: {
        type: DataTypes.DECIMAL(10, 2),
        defaultValue: 0
    },
    fuel_cost_per_km: {
        type: DataTypes.DECIMAL(10, 2),
        defaultValue: 1.0
    },
    is_rental: {
        type: DataTypes.BOOLEAN,
        defaultValue: false
    },
    status: {
        type: DataTypes.ENUM('active', 'maintenance'),
        defaultValue: 'active'
    }
}, {
    tableName: 'vehicles',
    timestamps: false
});

module.exports = Vehicle;\n\n\n==================================================\nFILE: backend\routes\authRoutes.js\n==================================================\n\nconst express = require('express');
const router = express.Router();
const { register, login } = require('../controllers/authController');

router.post('/register', register);
router.post('/login', login);

module.exports = router;\n\n\n==================================================\nFILE: backend\routes\cargoRoutes.js\n==================================================\n\nconst express = require('express');
const router = express.Router();
const { createCargo, getAllCargos, bulkCreateCargos, deleteAllCargos } = require('../controllers/cargoController');
const authMiddleware = require('../middleware/authMiddleware'); // Sadece giriş yapanlar girebilsin

// Middleware ekledik: Önce kimlik kontrolü yapar, sonra controller'a gider
router.post('/', authMiddleware, createCargo);
router.get('/', authMiddleware, getAllCargos);
router.post('/bulk', authMiddleware, bulkCreateCargos);
router.delete('/', authMiddleware, deleteAllCargos);

module.exports = router;\n\n\n==================================================\nFILE: backend\routes\optimizationRoutes.js\n==================================================\n\nconst express = require('express');
const router = express.Router();
const { optimizeRoutes } = require('../controllers/optimizationController');

// POST isteği ile tetiklenecek: localhost:5000/api/optimize
router.post('/optimize', optimizeRoutes);
router.post('/analyze', require('../controllers/optimizationController').analyzeAllScenarios);

module.exports = router;\n\n\n==================================================\nFILE: backend\routes\stationRoutes.js\n==================================================\n\nconst express = require('express');
const router = express.Router();
const { getStations, createStation } = require('../controllers/stationController');

router.get('/', getStations);
router.post('/', createStation);

module.exports = router;\n\n\n==================================================\nFILE: backend\routes\vehicleRoutes.js\n==================================================\n\nconst express = require('express');
const router = express.Router();
const vehicleController = require('../controllers/vehicleController');
const authMiddleware = require('../middleware/authMiddleware');

router.get('/', authMiddleware, vehicleController.getVehicles);
router.post('/', authMiddleware, vehicleController.addVehicle);
router.get('/routes', authMiddleware, vehicleController.getVehicleRoutes); // New Endpoint
router.put('/:id/status', authMiddleware, vehicleController.updateVehicleStatus);
router.post('/optimize', authMiddleware, vehicleController.optimizeFleet); // Adding auth for consistency

module.exports = router;
\n\n\n==================================================\nFILE: backend\scripts\seed.js\n==================================================\n\nconst { sequelize, Station, Vehicle } = require('../models');

const seedDatabase = async () => {
    try {
        await sequelize.sync(); // Tabloların oluştuğundan emin ol

        // 1. İSTASYONLARI KONTROL ET VE EKLE
        const stationCount = await Station.count();
        if (stationCount === 0) {
            console.log('📍 İstasyonlar ekleniyor...');
            await Station.bulkCreate([
                { name: 'Kocaeli Üniversitesi (Merkez)', latitude: 40.8222, longitude: 29.9231, is_center: true },
                { name: 'Başiskele', latitude: 40.7180, longitude: 29.9320 },
                { name: 'Çayırova', latitude: 40.8170, longitude: 29.3750 },
                { name: 'Darıca', latitude: 40.7740, longitude: 29.4050 },
                { name: 'Derince', latitude: 40.7550, longitude: 29.8320 },
                { name: 'Dilovası', latitude: 40.7870, longitude: 29.5440 },
                { name: 'Gebze', latitude: 40.8020, longitude: 29.4300 },
                { name: 'Gölcük', latitude: 40.7160, longitude: 29.8210 },
                { name: 'Kandıra', latitude: 41.0710, longitude: 30.1500 },
                { name: 'Karamürsel', latitude: 40.6920, longitude: 29.6150 },
                { name: 'Kartepe', latitude: 40.7530, longitude: 30.0160 },
                { name: 'Körfez', latitude: 40.7710, longitude: 29.7360 },
                { name: 'İzmit', latitude: 40.7650, longitude: 29.9400 }
            ]);
        } else {
            console.log('✅ İstasyonlar zaten mevcut, ekleme yapılmadı.');
        }

        // 2. ARAÇLARI KONTROL ET VE EKLE
        const vehicleCount = await Vehicle.count();
        if (vehicleCount === 0) {
            console.log('🚛 Araçlar ekleniyor...');
            await Vehicle.bulkCreate([
                { plate_number: '41 SABIT 01', capacity_kg: 500, base_cost: 0, is_rental: false },
                { plate_number: '41 SABIT 02', capacity_kg: 750, base_cost: 0, is_rental: false },
                { plate_number: '41 SABIT 03', capacity_kg: 1000, base_cost: 0, is_rental: false }
            ]);
        } else {
            console.log('✅ Araçlar zaten mevcut, ekleme yapılmadı.');
        }

        console.log('🏁 Seed işlemi tamamlandı.');
        process.exit(0);
    } catch (error) {
        console.error('❌ Seed Hatası:', error);
        process.exit(1);
    }
};

seedDatabase();\n\n\n==================================================\nFILE: backend\scripts\testOptimization.js\n==================================================\n\nconst OptimizationService = require('../services/optimizationService');

async function test() {
    console.log('--- TEST 1: Within Fixed Capacity ---');
    // Total 2000kg. Fixed fleet is 2250 (1000+750+500). Should fit in fixed.
    let result = await OptimizationService.optimizeFleet(2000, 100);
    console.log('Weight: 2000, Dist: 100');
    console.log('Result:', JSON.stringify(result, null, 2));

    console.log('\n--- TEST 2: Exceeding Fixed Capacity ---');
    // Total 3000kg. Fixed 2250. Needs 750kg more.
    // Rental cap 500. So needs 2 rentals (500+500 = 1000 capacity > 750).
    result = await OptimizationService.optimizeFleet(3000, 100);
    console.log('Weight: 3000, Dist: 100');
    console.log('Result:', JSON.stringify(result, null, 2));

    console.log('\n--- TEST 3: Exact Fixed Capacity ---');
    // Total 2250. Should use all 3 fixed.
    result = await OptimizationService.optimizeFleet(2250, 100);
    console.log('Weight: 2250, Dist: 100');
    console.log('Result:', JSON.stringify(result, null, 2));
}

test();
\n\n\n==================================================\nFILE: backend\server.js\n==================================================\n\nconst express = require('express');
const cors = require('cors');
const dotenv = require('dotenv');
const { connectDB } = require('./config/db');

// Rota Dosyalarını Çağır
const authRoutes = require('./routes/authRoutes');
const stationRoutes = require('./routes/stationRoutes');
const cargoRoutes = require('./routes/cargoRoutes');
const optimizationRoutes = require('./routes/optimizationRoutes'); // Bunu zaten yapmıştık

dotenv.config();
const app = express();

app.use(cors());
app.use(express.json());

connectDB();

// Rotaları Kullan
app.use('/api/auth', authRoutes);       // Örn: localhost:5000/api/auth/login
app.use('/api/stations', stationRoutes); // Örn: localhost:5000/api/stations
app.use('/api/cargos', cargoRoutes);     // Örn: localhost:5000/api/cargos
app.use('/api/vehicles', require('./routes/vehicleRoutes')); // Yeni: Araç yönetimi
app.use('/api', optimizationRoutes);     // Örn: localhost:5000/api/optimize

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
    console.log(`Sunucu ${PORT} portunda çalışıyor.`);
});\n\n\n==================================================\nFILE: backend\services\optimizationService.js\n==================================================\n\nconst geolib = require('geolib');

class OptimizationService {

    /**
     * Calculate cost: (Base + Distance * Fuel)
     */
    static calculateRouteCost(vehicle, distanceKm) {
        return Number(vehicle.base_cost) + (distanceKm * Number(vehicle.fuel_cost_per_km));
    }

    /**
     * Helper: Sort cargos based on strategy for Knapsack
     * Strategies:
     * - 'WEIGHT': Maximize total weight (Heavier items first)
     * - 'COUNT': Maximize total count (Lighter items first)
     * - 'SAVINGS': VRP Savings method (not fully implemented here, using manual heuristic)
     * 
     * Current Heuristic for "Efficiency":
     * Score = (Weight) / (Distance from Center) [Prefer heavy items close to center?]
     * Actually for Knapsack with fixed capacity:
     * - Maximize Weight: Sort by Weight DESC
     * - Maximize Count: Sort by Weight ASC
     */
    static sortCargos(cargos, stations, centerStationId, strategy = 'WEIGHT') {
        return cargos.sort((a, b) => {
            if (strategy === 'COUNT') {
                return a.weight_kg - b.weight_kg; // Lightest first to fit more
            } else {
                return b.weight_kg - a.weight_kg; // Heaviest first to max utilization
            }
        });
    }

    /**
     * UNLIMITED FLEET MODE (VRP Variant)
     * Goal: Carry ALL cargo. Use fixed fleet first. If full, rent vehicles.
     * Optimization: Decide between "Detour on existing vehicle" vs "Rent new vehicle".
     */
    static async optimizeUnlimited(cargos, stations, fixedVehicles, distanceMatrix) {
        const assignments = [];
        const unassignedCargos = [...cargos]; // sort optional

        // 1. Fill Fixed Vehicles (Largest First)
        // Sort fixed vehicles by capacity DESC
        const sortedFixed = fixedVehicles.sort((a, b) => b.capacity_kg - a.capacity_kg);

        for (const vehicle of sortedFixed) {
            const currentAssignment = {
                vehicle: vehicle,
                isRental: false,
                cargos: [],
                currentLoad: 0,
                stations: new Set()
            };

            for (let i = unassignedCargos.length - 1; i >= 0; i--) {
                const cargo = unassignedCargos[i];
                if (currentAssignment.currentLoad + cargo.weight_kg <= vehicle.capacity_kg) {
                    currentAssignment.cargos.push(cargo);
                    currentAssignment.currentLoad += cargo.weight_kg;
                    currentAssignment.stations.add(cargo.station_id);
                    unassignedCargos.splice(i, 1);
                }
            }

            if (currentAssignment.cargos.length > 0) {
                assignments.push(currentAssignment);
            }
        }

        // 2. Handle Remaining with Rentals
        // Logic: Create rental vehicles (500kg, 200TL base).
        // Since we MUST carry everything in this mode, we just fill rentals.
        // Optimization opportunity: Could we squeeze a small rental load into a fixed vehicle by making a huge detour?
        // Check: Cost of Rental (200 + Dist) vs Cost of Detour (Dist * 1).
        // If Detour < 200, it's better. But we already filled fixed vehicles to capacity!
        // So we can only detour if there is capacity. But we just filled them.
        // So the only decision is: "New Rental" vs "Leave Behind" (but we must carry all).
        // So just fill rentals.

        while (unassignedCargos.length > 0) {
            const rental = {
                plate_number: `RENT-${assignments.length + 1}`,
                capacity_kg: 500,
                base_cost: 200,
                fuel_cost_per_km: 1,
                is_rental: true,
                id: null // Will be created in controller
            };

            const currentAssignment = {
                vehicle: rental,
                isRental: true,
                cargos: [],
                currentLoad: 0,
                stations: new Set()
            };

            for (let i = unassignedCargos.length - 1; i >= 0; i--) {
                const cargo = unassignedCargos[i];
                if (currentAssignment.currentLoad + cargo.weight_kg <= rental.capacity_kg) {
                    currentAssignment.cargos.push(cargo);
                    currentAssignment.currentLoad += cargo.weight_kg;
                    currentAssignment.stations.add(cargo.station_id);
                    unassignedCargos.splice(i, 1);
                }
            }

            // Force take at least one if it doesn't fit (Split cargo not supported, assuming single cargo < max rental)
            if (currentAssignment.cargos.length === 0 && unassignedCargos.length > 0) {
                const cargo = unassignedCargos.pop();
                currentAssignment.cargos.push(cargo);
                currentAssignment.currentLoad += cargo.weight_kg;
                currentAssignment.stations.add(cargo.station_id);
            }

            assignments.push(currentAssignment);
        }

        return { assignments, skippedCargos: [] };
    }

    /**
     * LIMITED FLEET MODE (Knapsack Variant)
     * Goal: Maximize success with ONLY fixed vehicles.
     * Strategy: 'WEIGHT' (Max Load) or 'COUNT' (Max number of orders)
     */
    static async optimizeLimited(cargos, stations, fixedVehicles, strategy, distanceMatrix, centerStationId) {
        const assignments = [];

        // 1. Score/Sort Cargos
        // Need to factor in Distance? 
        // "Efficient": Value/Weight.
        // Knapsack Value = 1 (Count) or Weight (Weight)
        // Cost = Space in truck
        // We also have "Cost" as in money (Distance).
        // If a cargo is very far, it "costs" more to deliver.
        // Heuristic: Value = (StrategyValue) / (DistanceCostFactor)

        // Let's attach a score to each cargo
        const scoredCargos = cargos.map(c => {
            const dist = distanceMatrix[centerStationId][c.station_id] || 1;
            // Avoid div by zero
            const d = dist === 0 ? 0.1 : dist;

            let value = 0;
            if (strategy === 'COUNT') value = 1;
            else value = c.weight_kg;

            // Simple heuristic: Value per km.
            // A 100kg cargo at 10km (score 10) is better than 100kg at 100km (score 1).
            return { ...c.dataValues, _score: value / d, _raw: c };
        });

        // Sort by Score DESC
        scoredCargos.sort((a, b) => b._score - a._score);

        const unassignedCargos = [...scoredCargos];
        const sortedFixed = fixedVehicles.sort((a, b) => b.capacity_kg - a.capacity_kg);

        for (const vehicle of sortedFixed) {
            const currentAssignment = {
                vehicle: vehicle,
                isRental: false,
                cargos: [],
                currentLoad: 0,
                stations: new Set()
            };

            for (let i = 0; i < unassignedCargos.length; i++) {
                const cargo = unassignedCargos[i];
                if (currentAssignment.currentLoad + cargo.weight_kg <= vehicle.capacity_kg) {
                    currentAssignment.cargos.push(cargo._raw);
                    currentAssignment.currentLoad += cargo.weight_kg;
                    currentAssignment.stations.add(cargo.station_id);

                    // Remove from list
                    unassignedCargos.splice(i, 1);
                    i--;
                }
            }
            if (currentAssignment.cargos.length > 0) {
                assignments.push(currentAssignment);
            }
        }

        return { assignments, skippedCargos: unassignedCargos.map(c => c._raw) };
    }
}

module.exports = OptimizationService;
\n\n